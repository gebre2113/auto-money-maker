name: Profit Master Supreme v12.1 (FIXED)

on:
  workflow_dispatch:      # á‰ áŠ¥áŒ… áˆ›áˆµáŠ¬áŒƒ
  schedule:
    - cron: '0 */6 * * *' # á‰ á‹¨6 áˆ°á‹“á‰±
  push:
    branches: [ main ]

# áˆˆ GitHub áˆá‰ƒá‹µ áˆ˜áˆµáŒ á‰µ (áˆªá–áˆ­á‰±áŠ• áˆ˜áˆáˆ¶ áŠ¥áŠ•á‹²á‹«áˆµá‰€áˆáŒ¥)
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # áˆáˆ‰áŠ•áˆ á‰ áŠ áŠ•á‹µ áˆ‹á‹­ áŠ á‹‹áˆ…áŒ„á‹‹áˆˆáˆ (Unified Job)
  run_profit_master:
    runs-on: ubuntu-latest
    name: "ğŸš€ Profit Master Engine Running"
    
    steps:
      - name: "ğŸ“¥ áŠ®á‹µ áˆ›á‹áˆ¨á‹µ"
        uses: actions/checkout@v4

      - name: "ğŸ Python áˆ›á‹‹á‰€áˆ­"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: "ğŸ“¦ áŠ áˆµáˆáˆ‹áŒŠ á“áŠ¬áŒ†á‰½ áˆ˜áŒ«áŠ•"
        run: |
          pip install pandas numpy matplotlib seaborn fpdf requests schedule

      - name: "ğŸ§  á‹‹áŠ“á‹áŠ• áŠ¢áŠ•áŒ‚áŠ• áˆ›áˆµáŠ¬á‹µ (AI & Data)"
        env:
          # á‰áˆá áŠ«áˆˆ á‹­áŒ á‰€áˆ›áˆá£ áŠ¨áˆŒáˆˆ á‰  Simulation á‹­áˆ°áˆ«áˆ
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "
import os, json, random, sqlite3, datetime
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# --- CONFIGURATION ---
DB_NAME = 'profit_master.db'
OUTPUT_DIR = 'profit_output'
os.makedirs(OUTPUT_DIR, exist_ok=True)

print('ğŸš€ Profit Master v12.1 Engine Starting...')

# --- DATABASE SETUP ---
conn = sqlite3.connect(DB_NAME)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS content (id TEXT, topic TEXT, type TEXT, words INT, revenue REAL, date TEXT)''')
c.execute('''CREATE TABLE IF NOT EXISTS metrics (date TEXT, daily_revenue REAL, traffic INT, conversion_rate REAL)''')
conn.commit()

# --- 1. CONTENT GENERATION & SIMULATION ---
topics = ['AI Automation 2026', 'Passive Income Strategies', 'Crypto Arbitrage', 'Affiliate Marketing Pro', 'SaaS Growth Hacks']
content_types = ['Blog Post', 'Video Script', 'Email Sequence']

new_content = []
# 3-5 áŠ á‹³á‹²áˆµ á‹­á‹˜á‰¶á‰½áŠ• áˆ˜ááŒ áˆ­
for i in range(random.randint(3, 5)):
    item = {
        'id': f'cnt_{random.randint(1000,9999)}',
        'topic': random.choice(topics),
        'type': random.choice(content_types),
        'words': random.randint(800, 2500),
        'revenue': round(random.uniform(10.0, 150.0), 2),
        'date': datetime.datetime.now().strftime('%Y-%m-%d')
    }
    c.execute('INSERT INTO content VALUES (?,?,?,?,?,?)', 
              (item['id'], item['topic'], item['type'], item['words'], item['revenue'], item['date']))
    new_content.append(item)

conn.commit()
print(f'âœ… Generated {len(new_content)} new content pieces.')

# --- 2. DATA ANALYSIS ---
df = pd.read_sql_query('SELECT * FROM content', conn)
total_revenue = df['revenue'].sum()
avg_words = df['words'].mean()
content_count = len(df)

print(f'ğŸ“Š Analysis: Total Revenue: \${total_revenue:.2f} | Avg Words: {avg_words:.0f}')

# --- 3. CHART GENERATION ---
plt.figure(figsize=(10, 6))
# áŠ áˆµáˆ˜áˆ³á‹­ á‹³á‰³ áˆˆá‰»áˆ­á‰µ
dates = pd.date_range(end=datetime.datetime.now(), periods=7).strftime('%Y-%m-%d')
revs = [random.uniform(50, 300) for _ in range(7)]
plt.plot(dates, revs, marker='o', linestyle='-', color='#6366f1', linewidth=3)
plt.title('Weekly Revenue Trend', fontsize=16)
plt.ylabel('Revenue ($)')
plt.grid(True, alpha=0.3)
plt.savefig(f'{OUTPUT_DIR}/revenue_chart.png')
print('âœ… Revenue chart generated.')

# --- 4. HTML DASHBOARD GENERATION ---
html_content = f'''
<!DOCTYPE html>
<html lang=\"en\">
<head>
    <meta charset=\"UTF-8\">
    <title>Profit Master Dashboard</title>
    <style>
        body {{ font-family: 'Segoe UI', sans-serif; background: #f3f4f6; padding: 20px; }}
        .header {{ background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; }}
        .stats-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }}
        .card {{ background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }}
        .value {{ font-size: 2.5em; font-weight: bold; color: #1f2937; }}
        .label {{ color: #6b7280; font-weight: 500; }}
        table {{ width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }}
        th, td {{ padding: 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }}
        th {{ background: #f9fafb; }}
        .status-badge {{ background: #d1fae5; color: #065f46; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }}
    </style>
</head>
<body>
    <div class=\"header\">
        <h1>ğŸš€ Profit Master v12.1 Dashboard</h1>
        <p>AI-Driven Monetization Engine â€¢ Status: <span class=\"status-badge\">ACTIVE</span></p>
    </div>

    <div class=\"stats-grid\">
        <div class=\"card\">
            <div class=\"label\">Total Revenue</div>
            <div class=\"value\">${total_revenue:,.2f}</div>
        </div>
        <div class=\"card\">
            <div class=\"label\">Content Pieces</div>
            <div class=\"value\">{content_count}</div>
        </div>
        <div class=\"card\">
            <div class=\"label\">Avg. Word Count</div>
            <div class=\"value\">{avg_words:.0f}</div>
        </div>
        <div class=\"card\">
            <div class=\"label\">Next Run</div>
            <div class=\"value\">6 Hours</div>
        </div>
    </div>

    <div class=\"card\" style=\"margin-top: 20px;\">
        <h3>ğŸ“ˆ Revenue Trend</h3>
        <img src=\"revenue_chart.png\" style=\"width: 100%; max-width: 800px; border-radius: 10px;\">
    </div>

    <div class=\"card\" style=\"margin-top: 20px;\">
        <h3>ğŸ“ Latest AI Generated Content</h3>
        <table>
            <thead><tr><th>Topic</th><th>Type</th><th>Words</th><th>Est. Revenue</th></tr></thead>
            <tbody>
'''

for item in new_content:
    html_content += f\"<tr><td>{item['topic']}</td><td>{item['type']}</td><td>{item['words']}</td><td>${item['revenue']}</td></tr>\"

html_content += '''
            </tbody>
        </table>
    </div>
    
    <div style="text-align: center; margin-top: 30px; color: #6b7280;">
        Generated by Profit Master Engine on ''' + datetime.datetime.now().strftime('%Y-%m-%d %H:%M') + '''
    </div>
</body>
</html>
'''

with open(f'{OUTPUT_DIR}/index.html', 'w') as f:
    f.write(html_content)

print('âœ… HTML Dashboard generated successfully.')

# --- 5. NOTIFICATION (Telegram - Optional) ---
tg_token = os.getenv('TELEGRAM_BOT_TOKEN')
tg_chat = os.getenv('TELEGRAM_CHAT_ID')

if tg_token and tg_chat:
    import requests
    msg = f\"ğŸš€ *Profit Master Report*\\n\\nğŸ’° Revenue: ${total_revenue:,.2f}\\nğŸ“ Content: {content_count}\\nâœ… Run Complete!\"
    url = f\"https://api.telegram.org/bot{tg_token}/sendMessage\"
    try:
        requests.post(url, json={'chat_id': tg_chat, 'text': msg, 'parse_mode': 'Markdown'})
        print('âœ… Telegram notification sent.')
    except Exception as e:
        print(f'âŒ Telegram failed: {e}')
else:
    print('â„¹ï¸ Telegram tokens not found. Skipping notification.')

conn.close()
"

      - name: "ğŸ“¤ á‹áŒ¤á‰±áŠ• á‹ˆá‹° GitHub áˆ›áˆµáŒˆá‰£á‰µ (Commit)"
        run: |
          git config --global user.name "Profit Master Bot"
          git config --global user.email "bot@profitmaster.ai"
          git add profit_output/
          git commit -m "ğŸ“ˆ Update Profit Master Report: $(date)" || echo "No changes to commit"
          git push
          
      - name: "ğŸŒ áˆªá–áˆ­á‰±áŠ• áŠ¥áŠ•á‹° Artifact áˆ›áˆµá‰€áˆ˜áŒ¥"
        uses: actions/upload-artifact@v4
        with:
          name: full-report
          path: profit_output/
