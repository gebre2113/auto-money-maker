name: Profit Master Supreme v12.1 - Enhanced & Fixed Version

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action Type'
        required: true
        default: 'full_cycle'
        type: choice
        options: [full_cycle, content_gen]
  
  # ·â†·ã®6 ·à∞·ãì·â± ·ä•·äì ·â†·ã®·âÄ·äë 12:30 ·ä•·äï·ã≤·àÆ·å•
  schedule:
    - cron: '0 */6 * * *'
    - cron: '30 12 * * *'

permissions:
  contents: write # ·àà GitHub Pages ·àò·àç·âÄ·âÇ·ã´ ·ãà·à≥·äù ·äê·ãç

env:
  PYTHON_VERSION: '3.10'
  DATABASE_FILE: 'profit_master.db'
  OUTPUT_DIR: 'public'

jobs:
  # ==================== ·ã∞·à®·åÉ 1: ·àµ·à≠·ãì·âµ ·àõ·àµ·äê·àª ====================
  system_setup:
    runs-on: ubuntu-latest
    name: "üîß System Setup & Boot"
    outputs:
      session_id: ${{ steps.gen_session.outputs.session_id }}
    
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üêç Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "üì¶ Install Dependencies"
        run: |
          pip install pandas numpy requests
          mkdir -p ${{ env.OUTPUT_DIR }}

      - name: "üÜî Generate Session ID"
        id: gen_session
        run: echo "session_id=PM_$(date +%Y%m%d)_${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: "üóÑÔ∏è Initialize Database"
        run: |
          cat << 'EOF' > init_db.py
          import sqlite3, json, os, datetime
          
          db_path = os.environ.get('DATABASE_FILE', 'profit_master.db')
          output_dir = os.environ.get('OUTPUT_DIR', 'public')
          
          # DB ·àò·çç·å†·à≠
          conn = sqlite3.connect(db_path)
          c = conn.cursor()
          
          c.execute('CREATE TABLE IF NOT EXISTS content_items (id TEXT, title TEXT, type TEXT, words INT, quality INT, potential REAL, created_at TEXT)')
          c.execute('CREATE TABLE IF NOT EXISTS revenue_events (id TEXT, source TEXT, amount REAL, platform TEXT, date TEXT)')
          
          conn.commit()
          conn.close()
          
          # ·à≤·àµ·â∞·àù ·ä¢·äï·çé
          info = {
              "status": "BOOT_COMPLETE", 
              "timestamp": datetime.datetime.now().isoformat(),
              "version": "12.1"
          }
          with open(f'{output_dir}/system_info.json', 'w') as f:
              json.dump(info, f, indent=2)
          
          print(f"‚úÖ Database initialized at {db_path}")
          EOF
          
          python3 init_db.py

      - name: "üì§ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: system-data
          path: |
            ${{ env.DATABASE_FILE }}
            ${{ env.OUTPUT_DIR }}/

  # ==================== ·ã∞·à®·åÉ 2: ·ã≠·ãò·âµ ·àõ·àò·äï·å®·âµ ====================
  content_generation:
    needs: system_setup
    runs-on: ubuntu-latest
    name: "üß† AI Content Generation"
    
    steps:
      - name: "üì• Download System Data"
        uses: actions/download-artifact@v4
        with:
          name: system-data

      - name: "üêç Setup Python & Libs"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: "üì¶ Install Libs"
        run: pip install pandas numpy

      - name: "üìù Generate Content"
        run: |
          cat << 'EOF' > content_gen.py
          import sqlite3, json, random, datetime, os
          import pandas as pd
          
          db_path = os.environ.get('DATABASE_FILE')
          output_dir = os.environ.get('OUTPUT_DIR')
          
          conn = sqlite3.connect(db_path)
          
          topics = ["AI Monetization", "Passive Income", "Affiliate SEO", "Crypto Bots"]
          types = ["Blog", "Guide", "Review"]
          
          new_items = []
          for i in range(10):
              item = {
                  'id': f"cnt_{random.randint(1000,9999)}",
                  'title': f"{random.choice(topics)} - Part {i+1}",
                  'type': random.choice(types),
                  'words': random.randint(800, 2500),
                  'quality': random.randint(85, 99),
                  'potential': round(random.uniform(50, 500), 2),
                  'date': datetime.datetime.now().isoformat()
              }
              
              conn.execute('INSERT INTO content_items VALUES (?,?,?,?,?,?,?)', 
                  (item['id'], item['title'], item['type'], item['words'], item['quality'], item['potential'], item['date']))
              new_items.append(item)
          
          conn.commit()
          
          # JSON ·à™·çñ·à≠·âµ
          report = {"generated_count": len(new_items), "items": new_items}
          with open(f'{output_dir}/content_report.json', 'w') as f:
              json.dump(report, f, indent=2)
              
          print(f"‚úÖ Generated {len(new_items)} articles")
          EOF
          
          python3 content_gen.py

      - name: "üì§ Upload Content Data"
        uses: actions/upload-artifact@v4
        with:
          name: content-results
          path: |
            ${{ env.DATABASE_FILE }}
            ${{ env.OUTPUT_DIR }}/

  # ==================== ·ã∞·à®·åÉ 3: ·åà·â¢ ·âµ·äï·â∞·äì ·ä•·äì ·ã≥·àΩ·â¶·à≠·ãµ ====================
  revenue_analytics:
    needs: content_generation
    runs-on: ubuntu-latest
    name: "üí∞ Revenue & Dashboard"
    
    steps:
      - name: "üì• Download Content Data"
        uses: actions/download-artifact@v4
        with:
          name: content-results

      - name: "üêç Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: "üì¶ Install Libs"
        run: pip install pandas matplotlib seaborn

      - name: "üìä Analyze & Create Dashboard"
        run: |
          cat << 'EOF' > dashboard.py
          import sqlite3, json, random, datetime, os
          import pandas as pd
          import matplotlib.pyplot as plt
          
          db_path = os.environ.get('DATABASE_FILE')
          output_dir = os.environ.get('OUTPUT_DIR')
          conn = sqlite3.connect(db_path)
          
          # 1. Simulate Revenue
          sources = ['Affiliate', 'Ads', 'Sponsorship']
          platforms = ['Web', 'Social', 'Email']
          
          for _ in range(20):
              conn.execute('INSERT INTO revenue_events VALUES (?,?,?,?,?)',
                  (f"rev_{random.randint(1000,9999)}", random.choice(sources), 
                   round(random.uniform(10, 200), 2), random.choice(platforms), 
                   datetime.datetime.now().strftime('%Y-%m-%d')))
          conn.commit()
          
          # 2. Analyze
          df_rev = pd.read_sql('SELECT * FROM revenue_events', conn)
          df_cnt = pd.read_sql('SELECT * FROM content_items', conn)
          
          total_rev = df_rev['amount'].sum()
          top_source = df_rev.groupby('source')['amount'].sum().idxmax()
          avg_quality = df_cnt['quality'].mean()
          
          # 3. Create Charts
          plt.figure(figsize=(8,5))
          df_rev.groupby('source')['amount'].sum().plot(kind='bar', color='#6366f1')
          plt.title('Revenue by Source')
          plt.tight_layout()
          plt.savefig(f'{output_dir}/revenue_chart.png')
          
          # 4. Generate HTML Dashboard
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Profit Master Supreme v12.1</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <style>
                  body {{ background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }}
                  .header {{ background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px 0; margin-bottom: 30px; }}
                  .card {{ border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }}
                  .card:hover {{ transform: translateY(-5px); }}
                  .metric {{ font-size: 2.5rem; font-weight: bold; color: #333; }}
              </style>
          </head>
          <body>
              <div class="header text-center">
                  <h1>üöÄ Profit Master Supreme v12.1</h1>
                  <p class="lead">AI-Powered Monetization Dashboard</p>
                  <span class="badge bg-success">SYSTEM ACTIVE</span>
              </div>
              
              <div class="container">
                  <div class="row text-center mb-4">
                      <div class="col-md-4">
                          <div class="card p-4">
                              <div class="text-muted">Total Revenue</div>
                              <div class="metric text-success">${total_rev:,.2f}</div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card p-4">
                              <div class="text-muted">Content Generated</div>
                              <div class="metric text-primary">{len(df_cnt)}</div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card p-4">
                              <div class="text-muted">Quality Score</div>
                              <div class="metric text-warning">{avg_quality:.1f}</div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <div class="card p-3">
                              <h4 class="mb-3">Revenue Analysis</h4>
                              <img src="revenue_chart.png" class="img-fluid rounded">
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card p-3">
                              <h4 class="mb-3">Top Performing Content</h4>
                              <ul class="list-group list-group-flush">
          """
          
          for _, row in df_cnt.nlargest(5, 'potential').iterrows():
              html += f'<li class="list-group-item d-flex justify-content-between"><span>{row["title"]}</span> <span class="fw-bold">${row["potential"]}</span></li>'
          
          html += f"""
                              </ul>
                          </div>
                      </div>
                  </div>
                  
                  <div class="text-center mt-5 text-muted">
                      <p>Run ID: {os.environ.get('GITHUB_RUN_ID')} ‚Ä¢ Last Update: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}</p>
                  </div>
              </div>
          </body>
          </html>
          """
          
          with open(f'{output_dir}/index.html', 'w') as f:
              f.write(html)
          
          print("‚úÖ Dashboard generated at index.html")
          EOF
          
          python3 dashboard.py

      - name: "üì§ Upload Final Assets"
        uses: actions/upload-artifact@v4
        with:
          name: final-results
          path: ${{ env.OUTPUT_DIR }}/

  # ==================== ·ã∞·à®·åÉ 4: ·àò·àç·âÄ·âÖ (Deployment) ====================
  deploy:
    needs: revenue_analytics
    runs-on: ubuntu-latest
    name: "üöÄ Deploy to GitHub Pages"
    
    steps:
      - name: "üì• Download Assets"
        uses: actions/download-artifact@v4
        with:
          name: final-results
          path: public

      - name: "üåê Deploy to GitHub Pages"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: "‚úÖ Final Report"
        run: |
          echo "Deployment Complete!"
          echo "Visit: https://${{ github.repository_owner }}.github.io/${{ github.repository }}/"
