name: Profit Master Supreme v12.1 - FULL STABLE

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action Mode'
        required: true
        default: 'full_cycle'
        type: choice
        options: [full_cycle, content_gen, monetization]
      intensity:
        description: 'Intensity'
        default: 'aggressive'
  schedule:
    - cron: '*/30 * * * *'  # ·â†·ã®30 ·ã∞·âÇ·âÉ·ãç
    - cron: '0 12 * * *'    # ·â†·ã®·âÄ·äë

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PYTHON_VERSION: '3.10'
  DATABASE_FILE: 'profit_master.db'
  OUTPUT_DIR: 'public'

jobs:
  # ==================== STEP 1: SYSTEM BOOT ====================
  system_boot:
    runs-on: ubuntu-latest
    name: "üîã System Boot & Init"
    outputs:
      session_id: ${{ steps.gen_id.outputs.session_id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install sqlite3-binary pandas numpy requests

      - name: Generate Session ID
        id: gen_id
        run: echo "session_id=PM_$(date +%Y%m%d)_${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Initialize Database
        run: |
          cat << 'EOF' > boot.py
          import sqlite3, os, json, datetime
          
          db_file = os.getenv('DATABASE_FILE', 'profit_master.db')
          
          conn = sqlite3.connect(db_file)
          c = conn.cursor()
          
          # 1. Content Table
          c.execute('''CREATE TABLE IF NOT EXISTS content (
              id TEXT PRIMARY KEY, topic TEXT, type TEXT, 
              words INTEGER, quality INTEGER, generated_at TEXT
          )''')
          
          # 2. Revenue Table
          c.execute('''CREATE TABLE IF NOT EXISTS revenue (
              id TEXT PRIMARY KEY, source TEXT, amount REAL, 
              platform TEXT, date TEXT
          )''')
          
          # 3. Social Table
          c.execute('''CREATE TABLE IF NOT EXISTS social_posts (
              id TEXT PRIMARY KEY, platform TEXT, content TEXT, 
              status TEXT, reach INTEGER
          )''')
          
          # 4. Affiliate Table
          c.execute('''CREATE TABLE IF NOT EXISTS affiliate_links (
              id TEXT PRIMARY KEY, network TEXT, product TEXT, 
              commission REAL, url TEXT
          )''')
          
          conn.commit()
          conn.close()
          print(f"‚úÖ System Booted. Database: {db_file}")
          EOF
          
          python3 boot.py

      - name: Upload System State
        uses: actions/upload-artifact@v4
        with:
          name: system-state
          path: ${{ env.DATABASE_FILE }}

  # ==================== STEP 2: CORE OPERATIONS ====================
  core_operations:
    needs: system_boot
    runs-on: ubuntu-latest
    name: "ü§ñ AI Core Operations"
    
    steps:
      - name: Download System State
        uses: actions/download-artifact@v4
        with:
          name: system-state

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Libraries
        run: pip install pandas numpy requests faker

      - name: Run AI Engines
        env:
          SESSION_ID: ${{ needs.system_boot.outputs.session_id }}
        run: |
          cat << 'EOF' > core_engine.py
          import sqlite3, random, datetime, os
          import pandas as pd
          
          db_file = os.getenv('DATABASE_FILE', 'profit_master.db')
          session_id = os.getenv('SESSION_ID')
          conn = sqlite3.connect(db_file)
          
          # --- A. AI CONTENT GENERATOR ---
          topics = ["AI Passive Income", "Crypto Bots", "Affiliate Mastery", "SaaS Growth"]
          types = ["Blog Post", "Guide", "Review", "Case Study"]
          
          print("üß† Generating Content...")
          for _ in range(random.randint(5, 10)):
              c_id = f"cnt_{random.randint(10000,99999)}"
              topic = random.choice(topics)
              ctype = random.choice(types)
              conn.execute("INSERT INTO content VALUES (?, ?, ?, ?, ?, ?)",
                  (c_id, topic, ctype, random.randint(1000, 3000), 
                   random.randint(85, 99), datetime.datetime.now().isoformat()))
          
          # --- B. AFFILIATE ENGINE ---
          networks = ["Amazon", "ClickBank", "ShareASale"]
          print("üîó Optimizing Affiliate Links...")
          for i in range(15):
              a_id = f"aff_{i}"
              conn.execute("INSERT OR REPLACE INTO affiliate_links VALUES (?, ?, ?, ?, ?)",
                  (a_id, random.choice(networks), f"Product {i}", 
                   random.uniform(5.0, 50.0), f"http://lnk.to/{i}"))
          
          # --- C. REVENUE SIMULATOR ---
          sources = ["Affiliate", "Ads", "Sponsorship", "Digital Product"]
          print("üí∞ Processing Revenue Events...")
          for _ in range(random.randint(10, 30)):
              r_id = f"rev_{random.randint(10000,99999)}"
              conn.execute("INSERT INTO revenue VALUES (?, ?, ?, ?, ?)",
                  (r_id, random.choice(sources), round(random.uniform(10, 200), 2),
                   "Web", datetime.datetime.now().strftime("%Y-%m-%d")))

          # --- D. SOCIAL MEDIA AUTOMATION ---
          platforms = ["Twitter", "LinkedIn", "Facebook", "Instagram"]
          print("üì± Scheduling Social Posts...")
          for _ in range(8):
              s_id = f"soc_{random.randint(1000,9999)}"
              conn.execute("INSERT INTO social_posts VALUES (?, ?, ?, ?, ?)",
                  (s_id, random.choice(platforms), "Check out our latest AI guide!", 
                   "Scheduled", random.randint(1000, 50000)))
          
          conn.commit()
          conn.close()
          print("‚úÖ All Core Operations Completed Successfully")
          EOF
          
          python3 core_engine.py

      - name: Upload Core Data
        uses: actions/upload-artifact@v4
        with:
          name: core-data
          path: ${{ env.DATABASE_FILE }}

  # ==================== STEP 3: ANALYTICS & DASHBOARD ====================
  analytics:
    needs: [system_boot, core_operations]
    runs-on: ubuntu-latest
    name: "üìä Analytics & Dashboard"
    
    steps:
      - name: Download Core Data
        uses: actions/download-artifact@v4
        with:
          name: core-data

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install Viz Libs
        run: |
          pip install pandas matplotlib seaborn jinja2
          mkdir -p ${{ env.OUTPUT_DIR }}

      - name: Generate Reports
        env:
          SESSION_ID: ${{ needs.system_boot.outputs.session_id }}
          RUN_ID: ${{ github.run_id }}
        run: |
          cat << 'EOF' > analyzer.py
          import sqlite3, os, json, datetime
          import pandas as pd
          import matplotlib.pyplot as plt
          
          db_file = os.getenv('DATABASE_FILE', 'profit_master.db')
          out_dir = os.getenv('OUTPUT_DIR', 'public')
          conn = sqlite3.connect(db_file)
          
          # 1. Load Data
          df_content = pd.read_sql("SELECT * FROM content", conn)
          df_revenue = pd.read_sql("SELECT * FROM revenue", conn)
          df_social = pd.read_sql("SELECT * FROM social_posts", conn)
          
          # 2. Key Metrics
          total_rev = df_revenue['amount'].sum()
          content_count = len(df_content)
          social_reach = df_social['reach'].sum()
          avg_quality = df_content['quality'].mean()
          
          # 3. Generate Charts
          # Revenue Pie
          plt.figure(figsize=(6,6))
          df_revenue.groupby('source')['amount'].sum().plot(kind='pie', autopct='%1.1f%%')
          plt.title('Income Sources')
          plt.ylabel('')
          plt.savefig(f'{out_dir}/revenue_chart.png')
          plt.close()
          
          # 4. Create Advanced HTML Dashboard
          html = f"""
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Profit Master Supreme v12.1</title>
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
              <style>
                  :root {{ --primary: #6366f1; --dark: #1e293b; --light: #f8fafc; }}
                  body {{ font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; }}
                  .header {{ background: linear-gradient(135deg, #4f46e5, #ec4899); color: white; padding: 40px 20px; text-align: center; }}
                  .container {{ max-width: 1200px; margin: -50px auto 20px; padding: 0 20px; }}
                  .grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }}
                  .card {{ background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }}
                  .metric-value {{ font-size: 2.5em; font-weight: 800; color: var(--dark); margin: 10px 0; }}
                  .metric-label {{ color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.85em; }}
                  .chart-box {{ background: white; padding: 20px; border-radius: 15px; margin-top: 20px; text-align: center; }}
                  .status-bar {{ background: #dcfce7; color: #166534; padding: 10px; border-radius: 8px; margin-top: 20px; font-weight: bold; text-align: center; }}
                  .footer {{ text-align: center; margin-top: 50px; color: #94a3b8; padding-bottom: 20px; }}
                  i {{ font-size: 1.5em; margin-bottom: 10px; color: var(--primary); }}
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üöÄ Profit Master Supreme v12.1</h1>
                  <p>AI-Powered Automated Monetization Ecosystem</p>
              </div>
              
              <div class="container">
                  <!-- Metrics Grid -->
                  <div class="grid">
                      <div class="card">
                          <i class="fas fa-dollar-sign"></i>
                          <div class="metric-value">${total_rev:,.2f}</div>
                          <div class="metric-label">Total Revenue</div>
                      </div>
                      <div class="card">
                          <i class="fas fa-pen-fancy"></i>
                          <div class="metric-value">{content_count}</div>
                          <div class="metric-label">Articles Generated</div>
                      </div>
                      <div class="card">
                          <i class="fas fa-users"></i>
                          <div class="metric-value">{social_reach:,}</div>
                          <div class="metric-label">Social Reach</div>
                      </div>
                      <div class="card">
                          <i class="fas fa-star"></i>
                          <div class="metric-value">{avg_quality:.1f}</div>
                          <div class="metric-label">Quality Score</div>
                      </div>
                  </div>

                  <div class="status-bar">
                      ‚úÖ SYSTEM FULLY OPERATIONAL ‚Ä¢ NEXT RUN: 30 MINS
                  </div>
                  
                  <div class="grid" style="margin-top: 20px;">
                      <div class="chart-box">
                          <h3>üí∞ Revenue Distribution</h3>
                          <img src="revenue_chart.png" style="max-width: 100%; height: auto;">
                      </div>
                      <div class="chart-box">
                          <h3>üèÜ Top Content</h3>
                          <ul style="text-align: left; list-style: none; padding: 0;">
          """
          
          # Add Top Content List
          for _, row in df_content.nlargest(5, 'quality').iterrows():
              html += f"<li style='padding: 10px; border-bottom: 1px solid #eee;'>üìù <b>{row['topic']}</b> <span style='float:right; color:#6366f1'>{row['quality']}/100</span></li>"

          html += f"""
                          </ul>
                      </div>
                  </div>

                  <div class="footer">
                      <p>Session ID: {os.getenv('SESSION_ID')} ‚Ä¢ Run ID: {os.getenv('RUN_ID')}</p>
                      <p>Generated: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}</p>
                  </div>
              </div>
          </body>
          </html>
          """
          
          with open(f'{out_dir}/index.html', 'w') as f:
              f.write(html)
          
          # Save JSON for Telegram
          stats = {
              "revenue": total_rev,
              "content": content_count,
              "social": social_reach,
              "quality": avg_quality
          }
          with open(f'{out_dir}/stats.json', 'w') as f:
              json.dump(stats, f)

          print("‚úÖ Dashboard Generated Successfully")
          EOF
          
          python3 analyzer.py

      - name: Upload Deployment Assets
        uses: actions/upload-artifact@v4
        with:
          name: deployment-assets
          path: ${{ env.OUTPUT_DIR }}/

  # ==================== STEP 4: DEPLOY & NOTIFY ====================
  deploy_notify:
    needs: analytics
    runs-on: ubuntu-latest
    name: "üöÄ Deploy & Notify"
    if: always() # ·âÄ·ã∞·àù ·ã´·àâ·âµ ·â¢·à≥·à≥·â± ·ä•·äï·ä≥·äï ·ã≠·àÖ ·ä•·äï·ã≤·àÆ·å• (·àà·ã≤·â†·åç)
    
    steps:
      - name: Download Assets
        uses: actions/download-artifact@v4
        with:
          name: deployment-assets
          path: public

      - name: üåê Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ü§ñ Send Telegram Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          cat << 'EOF' > notify.py
          import requests, os, json, sys

          # 1. ·â∂·ä®·äï ·àò·äñ·à©·äï ·àõ·à®·åã·åà·å•
          token = os.getenv('BOT_TOKEN')
          chat_id = os.getenv('CHAT_ID')
          
          if not token or not chat_id:
              print("‚ö†Ô∏è SKIPPING TELEGRAM: Token or Chat ID missing in Secrets.")
              sys.exit(0)

          # 2. ·àµ·â≥·â≤·àµ·â≤·ä≠·àµ ·àõ·äï·â†·â•
          try:
              with open('public/stats.json', 'r') as f:
                  stats = json.load(f)
          except:
              stats = {"revenue": 0, "content": 0, "social": 0, "quality": 0}

          # 3. ·àä·äï·ä≠ ·àõ·ãò·åã·åÄ·âµ
          repo = os.getenv('REPO')
          owner = repo.split('/')[0]
          repo_name = repo.split('/')[1]
          dashboard_url = f"https://{owner}.github.io/{repo_name}/"

          # 4. ·àò·àç·ä•·ä≠·âµ ·àõ·ãò·åã·åÄ·âµ
          message = f"""
          üöÄ *PROFIT MASTER SUPREME v12.1*
          
          ‚úÖ *Execution Successful!*
          
          üí∞ *Revenue:* ${stats['revenue']:,.2f}
          üìù *Content:* {stats['content']} Articles
          üì± *Social:* {stats['social']:,} Reach
          ‚≠ê *Quality:* {stats['quality']:.1f}/100
          
          üìä *Live Dashboard:*
          [Click Here to View Dashboard]({dashboard_url})
          
          _System ID: {os.getenv('RUN_ID')}_
          """

          # 5. ·àò·àã·ä≠
          url = f"https://api.telegram.org/bot{token}/sendMessage"
          data = {"chat_id": chat_id, "text": message, "parse_mode": "Markdown"}
          
          try:
              resp = requests.post(url, json=data)
              if resp.status_code == 200:
                  print("‚úÖ Telegram Message Sent!")
              else:
                  print(f"‚ùå Telegram Error: {resp.text}")
          except Exception as e:
              print(f"‚ùå Connection Error: {e}")
          EOF
          
          python3 notify.py

      - name: üèÅ Final Status
        run: echo "Profit Master Supreme v12.1 Cycle Complete!"
