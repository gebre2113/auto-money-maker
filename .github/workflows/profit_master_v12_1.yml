name: Profit Master v12.5 (Perfect Text Fix)

on:
  schedule:
    - cron: '*/45 * * * *'
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action Type'
        required: true
        default: 'full_cycle'
        type: choice
        options: [full_cycle, content_gen]

env:
  ECOSYSTEM_VERSION: "12.5.0"
  DATABASE_PATH: "profit_master.db"

jobs:
  # ==================== STEP 1: SYSTEM BOOT ====================
  boot_and_setup:
    runs-on: ubuntu-latest
    name: "üöÄ System Boot"
    outputs:
      session_id: ${{ steps.gen_id.outputs.session_id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        run: |
          pip install pandas numpy requests schedule tenacity plotly jinja2 gTTS

      - name: Initialize Database
        run: |
          cat << 'EOF' > init_db.py
          import sqlite3, os
          conn = sqlite3.connect('profit_master.db')
          c = conn.cursor()
          c.execute('CREATE TABLE IF NOT EXISTS content (id TEXT, topic TEXT, type TEXT, quality INTEGER, filename TEXT, created_at DATETIME)')
          conn.commit()
          conn.close()
          print("‚úÖ Database Initialized")
          EOF
          python3 init_db.py

      - name: Generate Session ID
        id: gen_id
        run: |
          SID="PM_$(date +%Y%m%d%H%M%S)"
          echo "session_id=$SID" >> $GITHUB_OUTPUT

      - name: Upload System State
        uses: actions/upload-artifact@v4
        with:
          name: system-state
          path: profit_master.db

  # ==================== STEP 2: CONTENT ENGINE ====================
  content_engine:
    needs: boot_and_setup
    runs-on: ubuntu-latest
    name: "üíé Content Generator"
    
    steps:
      - name: Download State
        uses: actions/download-artifact@v4
        with:
          name: system-state

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Audio Libs
        run: pip install gTTS

      - name: Run Generator
        env:
          SESSION_ID: ${{ needs.boot_and_setup.outputs.session_id }}
        run: |
          cat << 'EOF' > ai_engine.py
          import sqlite3, json, random, os
          from datetime import datetime
          from gtts import gTTS

          os.makedirs('articles', exist_ok=True)
          os.makedirs('audio', exist_ok=True)

          def get_dynamic_chapter(index, topic):
              # HERE IS THE FIX: using f-strings properly with variable insertion
              chapters_db = {
                  1: {"title": "The Foundation", "content": f"To master {topic}, you must first understand the core principles. In 2026, data is king. Without proper analysis, you are flying blind. Start by auditing your current assets."},
                  2: {"title": "Automation Tools", "content": f"Why work harder when AI can do it for you? To dominate in {topic}, you need the right software stack. We recommend using Python scripts and no-code platforms to handle 80% of your daily tasks. This frees you up for strategy."},
                  3: {"title": "Scaling Up", "content": f"Once you have a winning formula for {topic}, it's time to pour fuel on the fire. Reinvest 50% of your profits into ads and outreach. This is the fastest way to 10x your income."},
                  4: {"title": "Future Proofing", "content": f"The market for {topic} changes fast. Stay ahead by subscribing to industry newsletters and testing new beta features before your competitors do."}
              }
              return chapters_db.get(index, {"title": "Summary", "content": "Keep pushing forward."})

          def generate_html_page(topic, content, filename):
              # Beautiful Gradient Backgrounds
              colors = [
                  "linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%)", # Soft White
                  "linear-gradient(to top, #fff1eb 0%, #ace0f9 100%)", # Soft Blue/Pink
                  "linear-gradient(120deg, #f6d365 0%, #fda085 100%)", # Warm Orange
                  "linear-gradient(to top, #c471f5 0%, #fa71cd 100%)"  # Vivid Purple
              ]
              bg_style = random.choice(colors)

              return f"""
              <!DOCTYPE html>
              <html lang="en">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>{topic}</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                  <style>
                      body {{ background: {bg_style}; min-height: 100vh; font-family: 'Helvetica Neue', sans-serif; padding-bottom: 50px; }}
                      .container {{ max-width: 800px; background: rgba(255,255,255,0.9); padding: 50px; margin-top: 50px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }}
                      h1 {{ font-weight: 800; color: #333; }}
                      h2 {{ margin-top: 30px; color: #444; font-weight: bold; }}
                      p {{ font-size: 1.1rem; line-height: 1.7; color: #555; }}
                      .audio-player {{ background: #222; color: white; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <a href="../index.html" class="text-decoration-none">‚Üê Back to Dashboard</a>
                      <br><br>
                      <h1>{topic}</h1>
                      <p class="text-muted"><i class="far fa-clock"></i> {datetime.now().strftime('%B %d, %Y')} ‚Ä¢ AI Generated</p>
                      
                      <div class="audio-player">
                          <div><i class="fas fa-headphones"></i> Listen Now</div>
                          <audio controls style="height: 30px;">
                              <source src="../audio/{filename.replace('.html', '.mp3')}" type="audio/mpeg">
                          </audio>
                      </div>

                      <img src="https://source.unsplash.com/800x400/?technology,money,{random.randint(1,100)}" class="img-fluid rounded shadow mb-4 w-100">

                      {content}

                      <hr class="my-5">
                      <center>
                          <h3>Ready to scale?</h3>
                          <a href="#" class="btn btn-dark btn-lg px-5 rounded-pill">Start Now üöÄ</a>
                      </center>
                  </div>
              </body>
              </html>
              """

          def run_job():
              conn = sqlite3.connect('profit_master.db')
              c = conn.cursor()
              
              topics = ["AI Passive Income 2026", "Crypto Bots Strategy", "Affiliate Marketing Pro"]
              new_content = []
              revenue_est = 0

              print("üß† Generating Content...")
              for i in range(2):
                  topic = random.choice(topics)
                  c_id = f"art_{datetime.now().strftime('%M%S')}_{i}"
                  filename = f"{c_id}.html"
                  
                  # Content Generation
                  body = ""
                  audio_text = f"Welcome to {topic}. "
                  for ch in range(1, 5):
                      data = get_dynamic_chapter(ch, topic)
                      body += f"<h2>{ch}. {data['title']}</h2><p>{data['content']}</p>"
                      audio_text += f"{data['title']}. {data['content']} "

                  # Audio
                  tts = gTTS(text=audio_text[:500], lang='en')
                  tts.save(f"audio/{c_id}.mp3")

                  # HTML
                  full_html = generate_html_page(topic, body, filename)
                  with open(f"articles/{filename}", "w") as f: f.write(full_html)
                  
                  new_content.append({"topic": topic, "filename": filename})
                  revenue_est += random.randint(50, 200)

              report = {"articles": new_content, "revenue": revenue_est}
              with open('ai_report.json', 'w') as f: json.dump(report, f, indent=2)

          if __name__ == "__main__":
              run_job()
          EOF
          python3 ai_engine.py

      - name: Upload Data
        uses: actions/upload-artifact@v4
        with:
          name: ai-data
          path: |
            ai_report.json
            articles/
            audio/

  # ==================== STEP 3: DASHBOARD ====================
  dashboard:
    needs: content_engine
    runs-on: ubuntu-latest
    name: "üìä Dashboard"
    
    steps:
      - name: Download Data
        uses: actions/download-artifact@v4
        with:
          name: ai-data

      - name: Create Dashboard
        run: |
          cat << 'EOF' > generate_dashboard.py
          import json
          with open('ai_report.json', 'r') as f: data = json.load(f)
          
          cards = ""
          for art in data.get('articles', []):
              cards += f"""
              <div class="col-md-6 mb-4">
                  <div class="card h-100 shadow border-0" style="border-radius: 15px; overflow: hidden;">
                      <div class="card-body text-center p-5">
                          <h3 class="fw-bold mb-3">{art['topic']}</h3>
                          <a href="articles/{art['filename']}" class="btn btn-outline-dark btn-lg rounded-pill px-5">Read Now ‚ûî</a>
                      </div>
                  </div>
              </div>
              """
          
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Profit Master v12.5</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
              <style>
                  body {{ background: linear-gradient(120deg, #f6d365 0%, #fda085 100%); min-height: 100vh; font-family: 'Segoe UI', sans-serif; }}
                  .container {{ background: rgba(255,255,255,0.9); border-radius: 20px; padding: 40px; margin-top: 50px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1 class="text-center mb-5">üöÄ Profit Master v12.5</h1>
                  <h3 class="text-center mb-5">Revenue: ${data.get('revenue', 0):.2f}</h3>
                  <div class="row">{cards}</div>
              </div>
          </body>
          </html>
          """
          with open('index.html', 'w') as f: f.write(html)
          EOF
          python3 generate_dashboard.py

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: true

  # ==================== STEP 4: NOTIFY ====================
  notify:
    needs: dashboard
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Telegram
        env:
          BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "import os, requests; 
          repo = os.environ['GITHUB_REPOSITORY'];
          owner = os.environ['GITHUB_REPOSITORY_OWNER'];
          link = f'https://{owner}.github.io/{repo.split('/')[-1]}/';
          requests.post(f'https://api.telegram.org/bot{os.environ['BOT']}/sendMessage', 
          json={'chat_id': os.environ['CHAT'], 'text': f'‚ú® v12.5 Fixed & Ready!\\n\\nCheck Dashboard:\\n{link}'}) if os.environ.get('BOT') else None"
