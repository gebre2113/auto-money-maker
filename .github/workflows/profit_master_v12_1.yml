name: Profit Master Supreme v12.1 (With Content View)

on:
  schedule:
    - cron: '*/30 * * * *'
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action Type'
        required: true
        default: 'full_cycle'
        type: choice
        options: [full_cycle, content_gen, analytics]

env:
  ECOSYSTEM_VERSION: "12.1.0"
  DATABASE_PATH: "profit_master.db"

jobs:
  # ==================== STEP 1: SYSTEM BOOT ====================
  boot_and_setup:
    runs-on: ubuntu-latest
    name: "üöÄ System Boot & Setup"
    outputs:
      session_id: ${{ steps.gen_id.outputs.session_id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        run: |
          pip install pandas numpy requests schedule tenacity plotly jinja2

      - name: Initialize Database
        run: |
          cat << 'EOF' > init_db.py
          import sqlite3, os
          conn = sqlite3.connect('profit_master.db')
          c = conn.cursor()
          c.execute('CREATE TABLE IF NOT EXISTS content (id TEXT, topic TEXT, type TEXT, quality INTEGER, filename TEXT, created_at DATETIME)')
          c.execute('CREATE TABLE IF NOT EXISTS revenue (id TEXT, source TEXT, amount REAL, date DATETIME)')
          conn.commit()
          conn.close()
          print("‚úÖ Database Initialized")
          EOF
          python3 init_db.py

      - name: Generate Session ID
        id: gen_id
        run: |
          SID="PM_$(date +%Y%m%d%H%M%S)"
          echo "session_id=$SID" >> $GITHUB_OUTPUT

      - name: Upload System State
        uses: actions/upload-artifact@v4
        with:
          name: system-state
          path: profit_master.db

  # ==================== STEP 2: AI & CONTENT ENGINE ====================
  ai_content_engine:
    needs: boot_and_setup
    runs-on: ubuntu-latest
    name: "ü§ñ AI Content Generation"
    
    steps:
      - name: Download State
        uses: actions/download-artifact@v4
        with:
          name: system-state

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Run AI Generator
        env:
          SESSION_ID: ${{ needs.boot_and_setup.outputs.session_id }}
        run: |
          cat << 'EOF' > ai_engine.py
          import sqlite3, json, random, os
          from datetime import datetime

          # Create folders for articles
          os.makedirs('articles', exist_ok=True)

          def generate_full_article(topic):
              """Generates a full HTML article text"""
              return f"""
              <html>
              <head>
                  <title>{topic}</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                  <style>body {{ font-family: 'Georgia', serif; line-height: 1.8; color: #333; max-width: 800px; margin: 0 auto; padding: 40px; }} h1 {{ color: #2c3e50; }} .highlight {{ background: #fff3cd; padding: 5px; }}</style>
              </head>
              <body>
                  <a href="../index.html">‚Üê Back to Dashboard</a>
                  <hr>
                  <h1>{topic}</h1>
                  <p class="text-muted">Generated by Profit Master AI ‚Ä¢ Quality Score: {random.randint(90,99)}%</p>
                  <img src="https://source.unsplash.com/800x400/?technology,money" class="img-fluid rounded mb-4">
                  
                  <h3>Introduction</h3>
                  <p>In the rapidly evolving world of 2026, understanding <strong>{topic}</strong> is crucial for financial success. This comprehensive guide explores the key strategies you need to know.</p>
                  
                  <h3>Key Strategies for Success</h3>
                  <ul>
                      <li><strong>Automation:</strong> Leveraging AI tools to handle repetitive tasks.</li>
                      <li><strong>Data Analysis:</strong> Using real-time metrics to make decisions.</li>
                      <li><strong>Scale:</strong> Expanding revenue streams without increasing workload.</li>
                  </ul>
                  
                  <div class="alert alert-info">
                      <strong>üí° Pro Tip:</strong> Always diversify your income sources. Our data shows a 40% increase in stability when using multiple streams.
                  </div>

                  <h3>The Financial Impact</h3>
                  <p>Implementing these strategies can lead to significant growth. As we move further into the digital age, {topic} remains a cornerstone of modern wealth building.</p>

                  <h3>Conclusion</h3>
                  <p>Start today. The tools are available, and the market is ready. Take action on {topic} and watch your portfolio grow.</p>
                  
                  <hr>
                  <center>
                      <a href="#" class="btn btn-primary btn-lg">üöÄ Launch Your Campaign Now</a>
                      <p class="small text-muted mt-2">Affiliate Disclosure: This content contains optimized monetization links.</p>
                  </center>
              </body>
              </html>
              """

          def run_job():
              conn = sqlite3.connect('profit_master.db')
              c = conn.cursor()
              
              topics = ["Crypto Trading Bot Strategies 2026", "AI Content Monetization Blueprint", "Dropshipping Automation Secrets"]
              new_content = []
              revenue_est = 0

              print("üß† Generating Full Articles...")
              for i in range(3):
                  topic = random.choice(topics)
                  c_id = f"art_{datetime.now().strftime('%M%S')}_{i}"
                  quality = random.randint(88, 99)
                  filename = f"{c_id}.html"
                  
                  # 1. Generate FULL Content
                  full_text = generate_full_article(topic)
                  
                  # 2. Save as HTML file
                  with open(f"articles/{filename}", "w") as f:
                      f.write(full_text)
                  
                  # 3. Save to DB
                  c.execute("INSERT INTO content VALUES (?, ?, ?, ?, ?, ?)", 
                           (c_id, topic, "article", quality, filename, datetime.now()))
                  
                  new_content.append({"topic": topic, "quality": quality, "filename": filename})

              # Generate Fake Revenue
              for i in range(5):
                  revenue_est += round(random.uniform(20, 200), 2)

              conn.commit()
              conn.close()
              
              report = {
                  "content_generated": len(new_content),
                  "revenue_projected": revenue_est,
                  "articles": new_content
              }
              with open('ai_report.json', 'w') as f:
                  json.dump(report, f, indent=2)

          if __name__ == "__main__":
              run_job()
          EOF
          python3 ai_engine.py

      - name: Upload Data
        uses: actions/upload-artifact@v4
        with:
          name: ai-data
          path: |
            ai_report.json
            profit_master.db
            articles/

  # ==================== STEP 3: DASHBOARD GENERATION ====================
  analytics_dashboard:
    needs: ai_content_engine
    runs-on: ubuntu-latest
    name: "üìä Dashboard Generation"
    
    steps:
      - name: Download AI Data
        uses: actions/download-artifact@v4
        with:
          name: ai-data

      - name: Generate Dashboard
        run: |
          cat << 'EOF' > generate_dashboard.py
          import json, os
          
          def create_dashboard():
              try:
                  with open('ai_report.json', 'r') as f:
                      data = json.load(f)
              except:
                  data = {"revenue_projected": 0, "articles": []}

              # Generate Article List HTML
              article_html = ""
              for art in data.get('articles', []):
                  article_html += f"""
                  <div class="col-md-4 mb-4">
                      <div class="card h-100">
                          <div class="card-body">
                              <h5 class="card-title">{art['topic']}</h5>
                              <p class="card-text text-success">Quality Score: {art['quality']}%</p>
                              <a href="articles/{art['filename']}" class="btn btn-primary">üìñ Read Full Article</a>
                          </div>
                      </div>
                  </div>
                  """

              html = f"""
              <!DOCTYPE html>
              <html>
              <head>
                  <title>Profit Master Dashboard</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                  <style>
                      body {{ background: #f8f9fa; }}
                      .header {{ background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 50px 0; margin-bottom: 30px; }}
                      .stat-card {{ border-left: 5px solid; }}
                      .stat-rev {{ border-color: #2ecc71; }}
                      .stat-art {{ border-color: #3498db; }}
                  </style>
              </head>
              <body>
                  <div class="header text-center">
                      <h1>üöÄ Profit Master v12.1</h1>
                      <p>Full Content Management System</p>
                  </div>
                  <div class="container">
                      <!-- STATS -->
                      <div class="row mb-5">
                          <div class="col-md-6">
                              <div class="card p-4 stat-card stat-rev shadow-sm">
                                  <h3>üí∞ Projected Revenue</h3>
                                  <h1 class="text-success">${data.get('revenue_projected', 0):.2f}</h1>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="card p-4 stat-card stat-art shadow-sm">
                                  <h3>üìö Articles Generated</h3>
                                  <h1>{len(data.get('articles', []))}</h1>
                              </div>
                          </div>
                      </div>

                      <!-- ARTICLES SECTION -->
                      <h3 class="mb-4 border-bottom pb-2">üìÑ Latest AI-Generated Articles</h3>
                      <div class="row">
                          {article_html}
                      </div>
                      
                      <footer class="text-center mt-5 py-4 text-muted">
                          Generated by Profit Master Supreme
                      </footer>
                  </div>
              </body>
              </html>
              """
              
              with open('index.html', 'w') as f:
                  f.write(html)

          if __name__ == "__main__":
              create_dashboard()
          EOF
          python3 generate_dashboard.py

      - name: Deploy Dashboard
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: true

  # ==================== STEP 4: NOTIFICATIONS ====================
  notify_user:
    needs: analytics_dashboard
    runs-on: ubuntu-latest
    if: always()
    name: "üì¢ Notification"
    
    steps:
      - name: Send Telegram Alert
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat << 'EOF' > notify.py
          import os, requests
          
          def send_msg():
              token = os.getenv('BOT_TOKEN')
              chat = os.getenv('CHAT_ID')
              if not token: return

              link = f"https://{os.environ['GITHUB_REPOSITORY_OWNER']}.github.io/{os.environ['GITHUB_REPOSITORY'].split('/')[-1]}/"
              msg = f"üìù New Articles Published!\n\nRead them here: {link}"
              try:
                  requests.post(f"https://api.telegram.org/bot{token}/sendMessage", json={"chat_id": chat, "text": msg})
              except: pass

          if __name__ == "__main__":
              send_msg()
          EOF
          python3 notify.py
