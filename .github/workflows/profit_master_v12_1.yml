name: Profit Master Supreme v12.3 (Human-Like Content)

on:
  schedule:
    - cron: '*/45 * * * *'
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action Type'
        required: true
        default: 'full_cycle'
        type: choice
        options: [full_cycle, content_gen]

env:
  ECOSYSTEM_VERSION: "12.3.0"
  DATABASE_PATH: "profit_master.db"

jobs:
  # ==================== STEP 1: SYSTEM BOOT ====================
  boot_and_setup:
    runs-on: ubuntu-latest
    name: "üöÄ System Boot"
    outputs:
      session_id: ${{ steps.gen_id.outputs.session_id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        run: |
          pip install pandas numpy requests schedule tenacity plotly jinja2 gTTS

      - name: Initialize Database
        run: |
          cat << 'EOF' > init_db.py
          import sqlite3, os
          conn = sqlite3.connect('profit_master.db')
          c = conn.cursor()
          c.execute('CREATE TABLE IF NOT EXISTS content (id TEXT, topic TEXT, type TEXT, quality INTEGER, filename TEXT, created_at DATETIME)')
          conn.commit()
          conn.close()
          print("‚úÖ Database Initialized")
          EOF
          python3 init_db.py

      - name: Generate Session ID
        id: gen_id
        run: |
          SID="PM_$(date +%Y%m%d%H%M%S)"
          echo "session_id=$SID" >> $GITHUB_OUTPUT

      - name: Upload System State
        uses: actions/upload-artifact@v4
        with:
          name: system-state
          path: profit_master.db

  # ==================== STEP 2: HUMAN-LIKE CONTENT ENGINE ====================
  human_content_engine:
    needs: boot_and_setup
    runs-on: ubuntu-latest
    name: "üíé Human-Like Generator"
    
    steps:
      - name: Download State
        uses: actions/download-artifact@v4
        with:
          name: system-state

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Audio Libs
        run: pip install gTTS

      - name: Run Intelligent Generator
        env:
          SESSION_ID: ${{ needs.boot_and_setup.outputs.session_id }}
        run: |
          cat << 'EOF' > ai_engine.py
          import sqlite3, json, random, os
          from datetime import datetime
          from gtts import gTTS

          os.makedirs('articles', exist_ok=True)
          os.makedirs('audio', exist_ok=True)

          def get_dynamic_chapter(index, topic):
              """Returns different content based on chapter number"""
              
              chapters_db = {
                  1: {
                      "title": "Understanding the Fundamentals",
                      "content": f"Before diving into complex strategies, we must grasp the core mechanics of {topic}. In 2026, the landscape has shifted from basic implementation to AI-driven optimization. The foundation relies on three pillars: stability, liquidity, and automated execution. Without these, any strategy is built on sand.",
                      "tip": "Start small. Master the basics before automating."
                  },
                  2: {
                      "title": "The Tech Stack & Tools You Need",
                      "content": "You cannot win a digital war with analog weapons. To dominate in {topic}, you need the right software stack. We recommend a combination of predictive analytics AI, automated ledgers, and real-time monitoring dashboards. These tools reduce human error by 94% according to recent studies.",
                      "tip": "Invest in tools that offer API integration."
                  },
                  3: {
                      "title": "Risk Management & Security",
                      "content": "High rewards come with high risks. However, in the world of {topic}, most risks are manageable if you have a protocol. Diversification is your best defense. Never allocate more than 15% of your resources to a single high-volatility vector. Cybersecurity is also paramount; ensure 2FA and cold storage protocols are active.",
                      "tip": "If it seems too good to be true, double your due diligence."
                  },
                  4: {
                      "title": "Scaling Your Revenue Models",
                      "content": "Once your system is stable, it's time to scale. This doesn't mean working harder; it means increasing volume. In {topic}, scaling involves compounding your gains and reinvesting profits into higher-yield tiers. This is where the 'Snowball Effect' kicks in, turning small wins into massive monthly returns.",
                      "tip": "Reinvest 60% of profits for the first 6 months."
                  },
                  5: {
                      "title": "Future Trends & 2027 Outlook",
                      "content": "What's next for {topic}? Analysts predict a shift towards decentralized governance and quantum-resistant security. Preparing for these shifts now will put you miles ahead of the competition. The early adopters of the next wave will see the highest ROI.",
                      "tip": "Stay liquid to pivot quickly when new tech drops."
                  }
              }
              return chapters_db.get(index, {"title": "Bonus Strategy", "content": "Keep learning and adapting.", "tip": "Never stop testing."})

          def generate_long_content(topic):
              intro = f"""
              <p class="lead"><strong>{topic}</strong> is reshaping the financial landscape of 2026. This guide isn't just theory; it's a battle-tested blueprint used by top earners.</p>
              """
              
              chapters_html = ""
              full_text_for_audio = f"Welcome to this guide on {topic}. " + intro.replace("<p class=\"lead\">", "").replace("</p>", "")

              for i in range(1, 6):
                  data = get_dynamic_chapter(i, topic)
                  
                  chapters_html += f"""
                  <h2 class="mt-5 text-primary">{i}. {data['title']}</h2>
                  <div class="row my-4 align-items-center">
                      <div class="col-md-12">
                          <img src="https://source.unsplash.com/800x400/?business,tech,step{i},{random.randint(1,100)}" class="img-fluid rounded shadow-sm w-100" alt="{data['title']}">
                      </div>
                  </div>
                  <p>{data['content']}</p>
                  <div class="p-3 bg-light border-start border-5 border-success rounded">
                      <strong>üöÄ Pro Tip:</strong> {data['tip']}
                  </div>
                  """
                  
                  full_text_for_audio += f" Chapter {i}: {data['title']}. {data['content']} "

              faq_section = """
              <h3 class="mt-5">üí° Frequently Asked Questions</h3>
              <div class="accordion" id="faqAccordion">
                  <div class="card mb-2">
                      <div class="card-header"><strong>Is this beginner friendly?</strong></div>
                      <div class="card-body">Yes, Chapter 1 covers all the basics you need.</div>
                  </div>
                  <div class="card mb-2">
                      <div class="card-header"><strong>How much time is required?</strong></div>
                      <div class="card-body">With the automation tools mentioned in Chapter 2, less than 4 hours a week.</div>
                  </div>
              </div>
              """

              return intro + chapters_html + faq_section, full_text_for_audio

          def generate_html_page(topic, content, filename):
              return f"""
              <!DOCTYPE html>
              <html lang="en">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>{topic}</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                  <style>
                      body {{ background: #fdfbf7; font-family: 'Merriweather', serif; color: #333; }}
                      .container {{ max-width: 850px; background: #fff; padding: 60px; margin: 40px auto; border-radius: 8px; box-shadow: 0 12px 24px rgba(0,0,0,0.05); }}
                      h1 {{ font-family: 'Helvetica Neue', sans-serif; font-weight: 800; font-size: 2.8rem; margin-bottom: 10px; }}
                      h2 {{ font-family: 'Helvetica Neue', sans-serif; font-weight: 700; margin-top: 40px; }}
                      .meta {{ color: #777; font-size: 0.9rem; margin-bottom: 30px; font-family: sans-serif; }}
                      .audio-box {{ background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <a href="../index.html" class="text-decoration-none text-secondary">‚Üê Back to Dashboard</a>
                      <br><br>
                      <h1>{topic}</h1>
                      <div class="meta">
                          <span><i class="far fa-calendar"></i> {datetime.now().strftime('%B %d, %Y')}</span> ‚Ä¢ 
                          <span><i class="far fa-clock"></i> 10 Min Read</span> ‚Ä¢ 
                          <span><i class="fas fa-robot"></i> AI Generated</span>
                      </div>

                      <div class="audio-box">
                          <div><i class="fas fa-headphones"></i> &nbsp; <strong>Listen to Article</strong></div>
                          <audio controls style="height: 30px;">
                              <source src="../audio/{filename.replace('.html', '.mp3')}" type="audio/mpeg">
                          </audio>
                      </div>

                      {content}

                      <hr class="my-5">
                      <center>
                          <h3>Ready to start?</h3>
                          <a href="#" class="btn btn-success btn-lg px-5 rounded-pill">Get Started Now</a>
                      </center>
                  </div>
              </body>
              </html>
              """

          def run_job():
              conn = sqlite3.connect('profit_master.db')
              c = conn.cursor()
              
              topics = [
                  "Crypto Yield Farming 2026", 
                  "AI Affiliate Automation", 
                  "Dropshipping High-Ticket Items"
              ]
              
              new_content = []
              revenue_est = 0

              print("üß† Generating Intelligent Content...")
              for i in range(2):
                  topic = random.choice(topics)
                  c_id = f"art_{datetime.now().strftime('%M%S')}_{i}"
                  quality = random.randint(94, 99)
                  filename = f"{c_id}.html"
                  audio_filename = f"{c_id}.mp3"
                  
                  # 1. Generate Content (Text + Audio Script)
                  html_body, audio_script = generate_long_content(topic)
                  
                  # 2. Create Audio
                  tts = gTTS(text=audio_script[:1000], lang='en') # Limit for speed
                  tts.save(f"audio/{audio_filename}")
                  
                  # 3. Create HTML
                  full_html = generate_html_page(topic, html_body, filename)
                  with open(f"articles/{filename}", "w") as f:
                      f.write(full_html)
                  
                  # 4. DB Save
                  c.execute("INSERT INTO content VALUES (?, ?, ?, ?, ?, ?)", 
                           (c_id, topic, "article", quality, filename, datetime.now()))
                  
                  new_content.append({"topic": topic, "quality": quality, "filename": filename})
                  revenue_est += random.uniform(50, 200)

              conn.commit()
              conn.close()
              
              report = {"content_generated": len(new_content), "revenue_projected": revenue_est, "articles": new_content}
              with open('ai_report.json', 'w') as f:
                  json.dump(report, f, indent=2)

          if __name__ == "__main__":
              run_job()
          EOF
          python3 ai_engine.py

      - name: Upload Data
        uses: actions/upload-artifact@v4
        with:
          name: ai-data
          path: |
            ai_report.json
            profit_master.db
            articles/
            audio/

  # ==================== STEP 3: DASHBOARD ====================
  analytics_dashboard:
    needs: human_content_engine
    runs-on: ubuntu-latest
    name: "üìä Dashboard"
    
    steps:
      - name: Download Data
        uses: actions/download-artifact@v4
        with:
          name: ai-data

      - name: Create Index
        run: |
          cat << 'EOF' > generate_dashboard.py
          import json
          with open('ai_report.json', 'r') as f: data = json.load(f)
          
          cards = ""
          for art in data.get('articles', []):
              cards += f"""
              <div class="col-md-6 mb-4">
                  <div class="card shadow border-0">
                      <div class="card-body">
                          <h5 class="fw-bold">{art['topic']}</h5>
                          <span class="badge bg-success">Quality: {art['quality']}%</span>
                          <hr>
                          <a href="articles/{art['filename']}" class="btn btn-primary w-100">üìñ Read & Listen</a>
                      </div>
                  </div>
              </div>
              """
          
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Profit Master v12.3</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
          </head>
          <body class="bg-light">
              <div class="container py-5">
                  <h1 class="text-center mb-5">üöÄ Profit Master v12.3</h1>
                  <div class="row">{cards}</div>
              </div>
          </body>
          </html>
          """
          with open('index.html', 'w') as f: f.write(html)
          EOF
          python3 generate_dashboard.py

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: true

  # ==================== STEP 4: NOTIFY ====================
  notify:
    needs: analytics_dashboard
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Telegram
        env:
          BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "import os, requests; requests.post(f'https://api.telegram.org/bot{os.environ['BOT']}/sendMessage', json={'chat_id': os.environ['CHAT'], 'text': '‚úÖ v12.3 Content Ready!'}) if os.environ.get('BOT') else None"
