name: üöÄ Profit Master Elite - PRODUCTION RUN v2.0

on:
  workflow_dispatch:
    inputs:
      topic:
        description: '·ã®·ã≠·ãò·â± ·à≠·ãï·àµ (Content Topic)'
        required: false
        default: 'AI-Powered Content Creation Strategies 2026'
      countries:
        description: '·ã®·àö·ã∞·åà·çâ ·àÄ·åà·à´·âµ (comma-separated)'
        required: false
        default: 'US,GB,CA,AU,DE'
      content_type:
        description: '·ã®·ã≠·ãò·âµ ·ä†·ã≠·äê·âµ'
        required: false
        default: 'blog_post'
        type: choice
        options:
          - blog_post
          - product_review
          - how_to_guide
          - general
  schedule:
    - cron: '0 0 * * *'  # ·â†·ã®·âÄ·äë ·â† –ø–æ–ª–Ω–æ—á—å
  push:
    branches: [main, production]
    paths:
      - 'main_runner.py'
      - 'youtube_affiliate_system.py'
      - 'profit_master_system.py'

concurrency:
  group: production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-profit-machine:
    name: üè≠ Running The Elite Machine
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping" 
          --health-interval 10s           --health-timeout 5s 
          --health-retries 5

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: üêç Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: üîç Validate Required Secrets
      run: |
        echo "Validating secrets..."
        required_secrets=(
          "GROQ_API_KEY"
          "GEMINI_API_KEY"
          "YOUTUBE_API_KEY"
        )
        
        missing_secrets=()
        for secret in "${required_secrets[@]}"; do
          if [ -z "${!secret}" ]; then
            missing_secrets+=("$secret")
          fi
        done
        
        if [ ${#missing_secrets[@]} -gt 0 ]; then
          echo "‚ùå Missing required secrets: ${missing_secrets[*]}"
          exit 1
        else
          echo "‚úÖ All required secrets are present"
        fi
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}

    - name: üé• Install System Dependencies
      run: |
        echo "Installing system dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          ffmpeg \
          chromium-browser \          chromium-chromedriver \
          libgl1-mesa-glx \
          libglib2.0-0
        
        # Verify installations
        ffmpeg -version
        chromium-browser --version
        chromedriver --version

    - name: üì¶ Install Python Dependencies
      run: |
        echo "Installing Python dependencies..."
        python -m pip install --upgrade pip setuptools wheel
        
        # Core dependencies
        pip install \
          PyYAML==6.0.1 \
          groq==0.5.0 \
          google-generativeai==0.3.2 \
          moviepy==1.0.3 \
          pandas==2.1.3 \
          requests==2.31.0 \
          beautifulsoup4==4.12.2 \
          python-dotenv==1.0.0 \
          redis==5.0.1 \
          aioredis==2.0.1 \
          aiohttp==3.9.1 \
          textblob==0.17.1 \
          pydantic==1.10.11 \
          tenacity==8.2.3 \
          fastapi==0.104.0 \
          uvicorn==0.24.0 \
          httpx==0.25.0 \
          openai==1.3.0 \
          sqlalchemy==2.0.0 \
          nltk==3.8.1 \
          psutil==5.9.6 \
          jinja2==3.1.2 \
          numpy==1.24.3
        
        # Download NLTK data
        echo "Downloading NLTK data..."
        python -m nltk.downloader punkt
        python -m nltk.downloader stopwords
        python -m nltk.downloader averaged_perceptron_tagger
        
        # Download TextBlob corpora
        python -m textblob.download_corpora light

    - name: üìä Check System Resources      run: |
        echo "System Resource Check:"
        echo "======================"
        free -h
        df -h
        lscpu | grep -E '^CPU\(s\)|Model name|CPU MHz'
        
        # Check disk space
        if [ $(df / --output=pcent | tail -1 | tr -dc '0-9') -gt 90 ]; then
          echo "‚ö†Ô∏è Warning: Disk space is above 90%"
        fi

    - name: üöÄ Run Production Engine
      id: run_production
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        WP_URL: ${{ secrets.WP_URL }}
        WP_USERNAME: ${{ secrets.WP_USERNAME }}
        WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        REDIS_URL: redis://localhost:6379
        PYTHONUNBUFFERED: 1
      run: |
        echo "üî• Starting Profit Master Elite Production Engine..."
        echo "Topic: ${{ github.event.inputs.topic || 'AI-Powered Content Creation Strategies 2026' }}"
        echo "Countries: ${{ github.event.inputs.countries || 'US,GB,CA,AU,DE' }}"
        echo "Content Type: ${{ github.event.inputs.content_type || 'blog_post' }}"
        
        # Run the production engine with timeout
        timeout 3600 python main_runner.py \
          --topic "${{ github.event.inputs.topic || 'AI-Powered Content Creation Strategies 2026' }}" \
          --countries "${{ github.event.inputs.countries || 'US,GB,CA,AU,DE' }}" \
          --content-type "${{ github.event.inputs.content_type || 'blog_post' }}" || {
            echo "‚ö†Ô∏è Production completed with warnings or partial success"
            exit 0  # Don't fail the workflow on partial success
          }

    - name: üìà Generate Production Report
      if: always()
      run: |
        echo "Generating production summary..."
        
        if [ -d "production_outputs" ]; then
          echo "Production outputs found:"
          ls -lh production_outputs/
          
          # Count successful productions          json_count=$(find production_outputs -name "*.json" | wc -l)
          echo "JSON files generated: $json_count"
          
          # Get latest production file
          latest_file=$(ls -t production_outputs/*.json 2>/dev/null | head -n 1)
          if [ -n "$latest_file" ]; then
            echo "Latest production file: $latest_file"
            cat "$latest_file" | python -m json.tool
          fi
        else
          echo "‚ö†Ô∏è No production outputs found"
        fi

    - name: üíæ Save Production Output
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: elite-production-results-${{ github.run_number }}
        path: |
          production_outputs/
          logs/
        retention-days: 30
        if-no-files-found: warn

    - name: üìß Send Success Notification
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          message="‚úÖ Profit Master Elite Production Completed Successfully!
          
          üìä Production Summary:
          ‚Ä¢ Workflow Run: ${{ github.run_number }}
          ‚Ä¢ Topic: ${{ github.event.inputs.topic || 'AI-Powered Content Creation Strategies 2026' }}
          ‚Ä¢ Status: SUCCESS
          ‚Ä¢ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')
          
          üìÅ Results saved as artifact: elite-production-results-${{ github.run_number }}"
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$message" \
            -d parse_mode="Markdown"
        fi

    - name: üö® Send Failure Notification
      if: failure()
      env:        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          message="‚ùå Profit Master Elite Production FAILED!
          
          üìä Production Summary:
          ‚Ä¢ Workflow Run: ${{ github.run_number }}
          ‚Ä¢ Topic: ${{ github.event.inputs.topic || 'AI-Powered Content Creation Strategies 2026' }}
          ‚Ä¢ Status: FAILED
          ‚Ä¢ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')
          
          üîç Check logs and artifacts for details."
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$message" \
            -d parse_mode="Markdown"
        fi

    - name: üßπ Cleanup Temporary Files
      if: always()
      run: |
        echo "Cleaning up temporary files..."
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} +
        rm -rf .pytest_cache
        echo "Cleanup complete"

    - name: üìä Display Final Statistics
      if: always()
      run: |
        echo "================ FINAL STATISTICS ================"
        echo "Workflow Run: ${{ github.run_number }}"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Event: ${{ github.event_name }}"
        echo "Status: ${{ job.status }}"
        echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=================================================="
