name: Profit Master Supreme v16.1 - Py3.12 Auto-Fix

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==================== DIGITAL TWIN OPERATOR ====================
  digital_twin_execution:
    runs-on: ubuntu-latest
    name: "ğŸ¤– Digital Twin (Py3.12)"
    timeout-minutes: 120
    
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python 3.12"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # <--- á‹ˆá‹° 3.12 á‰°á‰€á‹­áˆ¯áˆ
          cache: 'pip'

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          
          # NLTK áŠ¥áŠ“ áˆŒáˆá‰½ á‹ˆáˆ³áŠ á“áŠ¬áŒ†á‰½áŠ• á‰ áŒáˆáŒ½ áŠ¥áŠ•áŒ«áŠ•
          pip install nltk spacy textblob
          
          # áˆŒáˆá‰½ á“áŠ¬áŒ†á‰½
          pip install pandas numpy requests schedule plotly streamlit
          pip install groq google-generativeai openai anthropic cohere
          pip install tweepy facebook-sdk python-telegram-bot discord-webhook
          pip install beautifulsoup4 lxml Pillow gTTS moviepy yt-dlp
          pip install sqlalchemy streamlit-option-menu pydantic fastapi uvicorn
          
          # NLTK Data áˆ˜áŒ«áŠ• (á‰ á‰€áŒ¥á‰³ á‰ á“á‹­á‰°áŠ• áˆµáŠ­áˆªá•á‰µ)
          python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords'); nltk.download('averaged_perceptron_tagger')"

      - name: "ğŸ§  Run Automation"
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MANUAL_TOPIC: ${{ github.event.inputs.topic }}
        run: |
          echo "ğŸš€ Profit Master Autopilot (Python 3.12) Starting..."
          
          # áˆµáŠ­áˆªá•á‰±áŠ• áˆáˆáŒ áˆ›áŒáŠ˜á‰µ
          SCRIPT_PATH=$(find . -maxdepth 2 -name "main.py" -o -name "profit_master_supreme.py" | head -n 1)
          
          if [ -z "$SCRIPT_PATH" ]; then
            echo "âŒ CRITICAL: 'main.py' not found!"
            exit 1
          fi
          
          echo "âœ… Using Script: $SCRIPT_PATH"

          # áŠ á‹á‰¶áˆ›á‰²áŠ­ áŠ á‹›á‹¥ (Wrapper)
          cat << 'EOF' > auto_runner.py
          import asyncio
          import os
          import sys
          import importlib.util
          import random
          import json
          from datetime import datetime

          # main.pyáŠ• áŠ¥áŠ•á‹° áˆáŒáˆ áˆ˜áŒ«áŠ• (Dynamic Import)
          script_path = sys.argv[1]
          spec = importlib.util.spec_from_file_location("main_module", script_path)
          main_module = importlib.util.module_from_spec(spec)
          sys.modules["main_module"] = main_module
          spec.loader.exec_module(main_module)

          async def run_autopilot():
              # 1. áˆ­á‹•áˆµ áˆ˜áˆáˆ¨áŒ¥
              manual_topic = os.getenv('MANUAL_TOPIC')
              topic = manual_topic if manual_topic else random.choice([
                  "AI Business Trends 2025", "Passive Income Ideas", "Crypto Future", "Affiliate Marketing"
              ])
              print(f"ğŸ¯ Selected Topic: {topic}")

              # 2. áˆµáˆ­á‹“á‰±áŠ• áˆ›áˆµáŒ€áˆ˜áˆ­ (áŠ¨ main.py áˆ‹á‹­ áŠ­ááˆá‰½áŠ• áˆ˜áŒ á‰€áˆ)
              try:
                  config = main_module.PremiumConfig()
                  system = main_module.UltimateProfitMasterSystem(config)
                  
                  # 3. áˆµáˆ«á‹áŠ• áˆ›áˆµáŠ¬á‹µ
                  result = await system.create_ultimate_content_package(topic=topic)
                  
                  # 4. á‹áŒ¤á‰±áŠ• áˆ›áˆµá‰€áˆ˜áŒ¥
                  os.makedirs('public', exist_ok=True)
                  with open('public/stats.json', 'w') as f:
                      stats = {
                          "topic": topic,
                          "revenue": result.get("monetization", {}).get("revenue_analysis", {}).get("total_revenue", 0),
                          "quality": result.get("content", {}).get("quality_score", 0),
                          "timestamp": datetime.now().isoformat()
                      }
                      json.dump(stats, f)
                      
                  print("âœ… Mission Accomplished!")
                  
              except Exception as e:
                  print(f"âŒ Error in autopilot: {e}")
                  # Fallback stats
                  os.makedirs('public', exist_ok=True)
                  with open('public/stats.json', 'w') as f:
                      json.dump({"topic": topic, "revenue": 0, "quality": 0, "error": str(e)}, f)

          if __name__ == "__main__":
              asyncio.run(run_autopilot())
          EOF
          
          # áŠ á‹á‰¶áˆ›á‰²áŠ­ áŠ á‹›á‹¡áŠ• áˆ›áˆµáŠ¬á‹µ (á‹¨á‰°áŒˆáŠ˜á‹áŠ• áˆµáŠ­áˆªá•á‰µ áˆ˜áŠ•áŒˆá‹µ á‰ áˆ˜áˆµáŒ á‰µ)
          python3 auto_runner.py "$SCRIPT_PATH"

      - name: "ğŸ“Š Generate Dashboard"
        if: always()
        run: |
          cat << 'EOF' > generate_dashboard.py
          import json, os, datetime
          
          try:
              with open('public/stats.json', 'r') as f: stats = json.load(f)
          except: stats = {"topic": "Init", "revenue": 0, "quality": 0}
          
          html = f"""
          <!DOCTYPE html>
          <html>
          <body style="background:#0f172a;color:white;font-family:sans-serif;padding:40px;text-align:center;">
              <h1 style="color:#38bdf8">ğŸš€ Profit Master v16.1 (Py3.12)</h1>
              <div style="background:#1e293b;padding:30px;border-radius:15px;display:inline-block;margin-top:20px;">
                  <h2>{stats.get('topic', 'Unknown')}</h2>
                  <p style="font-size:2em;font-weight:bold;color:#4ade80">${stats.get('revenue', 0):.2f}</p>
                  <p>Quality Score: {stats.get('quality', 0)}%</p>
                  <p style="color:#94a3b8;font-size:0.8em">{stats.get('timestamp', '')}</p>
              </div>
          </body>
          </html>
          """
          with open('public/index.html', 'w') as f: f.write(html)
          EOF
          python3 generate_dashboard.py

      - name: "ğŸŒ Deploy"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true

      - name: "ğŸ“² Notify"
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
        run: |
          cat << 'EOF' > notify.py
          import requests, os, json
          token = os.getenv('TG_TOKEN')
          chat = os.getenv('TG_CHAT')
          if token and chat:
              try:
                  with open('public/stats.json') as f: s = json.load(f)
                  url = f"https://{os.getenv('REPO').split('/')[0]}.github.io/{os.getenv('REPO').split('/')[1]}/"
                  msg = f"ğŸš€ *Profit Master Run*\nğŸ“Œ {s.get('topic')}\nğŸ’° ${s.get('revenue', 0)}\nğŸ”— [Dashboard]({url})"
                  requests.post(f"https://api.telegram.org/bot{token}/sendMessage", json={'chat_id': chat, 'text': msg, 'parse_mode': 'Markdown'})
              except: pass
          EOF
          python3 notify.py
