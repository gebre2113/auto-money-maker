name: Profit Master Supreme v16.0 - Full Autopilot

on:
  # 1. áŠ á‹á‰¶áˆ›á‰²áŠ­ (áˆ®á‰¦á‰µ) - á‰ á‹¨ 6 áˆ°á‹“á‰±
  schedule:
    - cron: '0 */6 * * *'
  
  # 2. áˆ›áŠ•á‹‹áˆ (áŠ áŠ•á‰° áˆµá‰µáˆáˆáŒ)
  workflow_dispatch:
    inputs:
      topic:
        description: 'áˆá‹© áˆ­á‹•áˆµ (áŠ«áˆá‰°áˆáˆ‹ áˆ®á‰¦á‰± á‹­áˆ˜áˆ­áŒ£áˆ)'
        required: false
        type: string
      mode:
        description: 'áŠ¦á•áˆ¬áˆ½áŠ• áˆá‹µ'
        default: 'full-cycle'
        type: choice
        options:
        - full-cycle
        - generate-only
        - social-only

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==================== áŠ áŠ•á‰°áŠ• á‹¨áˆšá‰°áŠ«á‹ á‹‹áŠ“á‹ áˆµáˆ« ====================
  digital_twin_execution:
    runs-on: ubuntu-latest
    name: "ğŸ¤– Digital Twin Operator"
    timeout-minutes: 120
    
    steps:
      # 1. á‹¨áˆµáˆ« á‰¦á‰³á‹áŠ• áˆ›á‹˜áŒ‹áŒ€á‰µ
      - name: "ğŸ“¥ á‹ˆá‹° á‰¢áˆ® áˆ˜áŒá‰£á‰µ (Checkout)"
        uses: actions/checkout@v4

      # 2. áˆ˜áˆ³áˆªá‹«á‹á‰½áŠ• áˆ›á‹˜áŒ‹áŒ€á‰µ
      - name: "ğŸ áˆ˜áˆ³áˆªá‹«á‹á‰½áŠ• áˆ›á‹˜áŒ‹áŒ€á‰µ (Python Setup)"
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. áŒ¥áŒˆáŠáŠá‰¶á‰½áŠ• áˆ˜áŒ«áŠ• (Install Dependencies)
      - name: "ğŸ“¦ áŠ áˆµáˆáˆ‹áŒŠ áŠáŒˆáˆ®á‰½áŠ• áˆ˜áŒ«áŠ•"
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          
          # á‹¨á“á‹­á‰°áŠ• áˆµáŠ­áˆªá•á‰µáˆ… á‹¨áˆšáˆáˆáŒ‹á‰¸á‹ áˆáˆ‰áˆ áŠáŒˆáˆ®á‰½
          pip install pandas numpy requests schedule plotly streamlit
          pip install groq google-generativeai openai anthropic cohere
          pip install tweepy facebook-sdk python-telegram-bot discord-webhook
          pip install beautifulsoup4 lxml Pillow gTTS moviepy yt-dlp
          pip install sqlalchemy streamlit-option-menu pydantic fastapi uvicorn
          
          # NLTK áˆ˜áˆ¨áŒƒá‹á‰½
          python -m nltk.downloader punkt stopwords averaged_perceptron_tagger

      # 4. áŠ áŠ•á‰°áŠ• á‰°áŠ­á‰¶ á‹¨áˆšáˆ°áˆ«á‹ "áŠ á‹á‰¶áˆ›á‰²áŠ­ áŠ á‹›á‹¥" (The Manager)
      - name: "ğŸ§  áˆµáˆ«á‹áŠ• áˆ›áˆµáŒ€áˆ˜áˆ­ (Run Automation)"
        env:
          # --- áˆšáˆµáŒ¥áˆ«á‹Š á‰áˆáá‰½ ---
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # --- áˆáˆ­áŒ«á‹á‰½ ---
          MANUAL_TOPIC: ${{ github.event.inputs.topic }}
          MODE: ${{ github.event.inputs.mode || 'full-cycle' }}
        run: |
          echo "ğŸš€ Profit Master Autopilot áŠ¥á‹¨áŒ€áˆ˜áˆ¨ áŠá‹..."
          
          # áˆµáŠ­áˆªá•á‰± áˆ˜áŠ–áˆ©áŠ• áˆ›áˆ¨áŒ‹áŒˆáŒ¥
          if [ ! -f "main.py" ]; then
            echo "âŒ CRITICAL: 'main.py' áŠ áˆá‰°áŒˆáŠ˜áˆ! áŠ¥á‰£áŠ­áˆ… á‹á‹­áˆ‰áŠ• á‰ á‹‹áŠ“á‹ ááˆá‹°áˆ­ áŠ áˆµá‰€áˆáŒ¥á¢"
            exit 1
          fi

          # á‹­áˆ… áŠ á‹á‰¶áˆ›á‰²áŠ­ áˆµáŠ­áˆªá•á‰µ á‹«áŠ•á‰°áŠ• main.py áŠ¥áŠ•á‹° áˆ‹á‹­á‰¥áˆ¨áˆª á‹­áŒ á‰€áˆ›áˆ
          cat << 'EOF' > auto_runner.py
          import asyncio
          import os
          import random
          import json
          import sys
          
          # á‹«áŠ•á‰°áŠ• á‹‹áŠ“ áˆµáŠ­áˆªá•á‰µ Import áˆ›á‹µáˆ¨áŒ
          # áˆ›áˆ³áˆ°á‰¢á‹«: main.py á‹áˆµáŒ¥ á‹«áˆ‰á‰µ áŠ­ááˆá‰½ (Classes) áŠ¥áŠ•á‹²áŒˆáŠ™ á‹«á‹°áˆ­áŒ‹áˆ
          try:
              from main import PremiumConfig, UltimateProfitMasterSystem
          except ImportError as e:
              print(f"âŒ Import Error: {e}")
              print("âš ï¸ main.py á‰ á‰µáŠ­áŠ­áˆ áˆ˜á‹‹á‰€áˆ©áŠ• áŠ áˆ¨áŒ‹áŒáŒ¥")
              sys.exit(1)

          async def run_autopilot():
              # 1. áˆ­á‹•áˆµ áˆ˜áˆáˆ¨áŒ¥ (áŠ áŠ•á‰° áŠ«áˆáˆ°áŒ áˆ… áˆ®á‰¦á‰± á‹­áˆ˜áˆ­áŒ£áˆ)
              manual_topic = os.getenv('MANUAL_TOPIC')
              if manual_topic and manual_topic.strip():
                  topic = manual_topic
                  print(f"ğŸ‘¤ á‰ áŠ¥áŒ… á‹¨á‰°áˆ°áŒ  áˆ­á‹•áˆµ: {topic}")
              else:
                  # á‰µáŠ©áˆµ áˆ­á‹•áˆ¶á‰½ (Trending Topics)
                  trending = [
                      "How AI is Changing Freelancing in 2025",
                      "Top 10 Passive Income Streams for Beginners",
                      "Cryptocurrency Market Analysis 2025",
                      "Affiliate Marketing Secrets with AI",
                      "Dropshipping vs Affiliate Marketing: Which is Better?",
                      "The Future of Remote Work Tools"
                  ]
                  topic = random.choice(trending)
                  print(f"ğŸ¤– áˆ®á‰¦á‰± á‹¨áˆ˜áˆ¨áŒ á‹ áˆ­á‹•áˆµ: {topic}")

              # 2. áˆµáˆ­á‹“á‰±áŠ• áˆ›áˆµáŒ€áˆ˜áˆ­
              print("âš™ï¸ áˆµáˆ­á‹“á‰±áŠ• á‰ áˆ›á‹˜áŒ‹áŒ€á‰µ áˆ‹á‹­...")
              config = PremiumConfig()
              system = UltimateProfitMasterSystem(config)
              
              # 3. áˆµáˆ«á‹áŠ• áˆ›áˆµáŠ¬á‹µ
              print(f"ğŸš€ {topic} áˆ‹á‹­ á‹­á‹˜á‰µ á‰ áˆ˜ááŒ áˆ­ áˆ‹á‹­...")
              result = await system.create_ultimate_content_package(
                  topic=topic,
                  language='en', # á‹ˆá‹­áˆ 'am' áˆˆáŠ áˆ›áˆ­áŠ›
                  country='US'
              )
              
              # 4. á‹áŒ¤á‰±áŠ• áˆ›áˆµá‰€áˆ˜áŒ¥
              os.makedirs('public/data', exist_ok=True)
              
              # á‹áŒ¤á‰±áŠ• áˆˆáˆªá–áˆ­á‰µ áˆ›á‹˜áŒ‹áŒ€á‰µ
              stats = {
                  "status": result.get("status", "unknown"),
                  "topic": topic,
                  "revenue": result.get("monetization", {}).get("revenue_analysis", {}).get("total_revenue", 0),
                  "quality": result.get("content", {}).get("quality_score", 0),
                  "articles_count": 1, # á‰ á‹šáˆ… á‹™áˆ­ 1 á‰°áˆáŒ¥áˆ¯áˆ
                  "generated_at": result.get("created_at")
              }
              
              with open('public/latest_stats.json', 'w') as f:
                  json.dump(stats, f)
                  
              print("âœ… á‰°áˆá‹•áŠ® á‰°áˆ³áŠ­á‰·áˆ!")
              print(f"ğŸ’° á‹¨á‰°áŒˆáˆ˜á‰° áŒˆá‰¢: ${stats['revenue']}")

          if __name__ == "__main__":
              asyncio.run(run_autopilot())
          EOF
          
          # áŠ á‹á‰¶áˆ›á‰²áŠ­ áŠ á‹›á‹¡áŠ• áˆ›áˆµáŠ¬á‹µ
          python3 auto_runner.py

      # 5. á‹³áˆ½á‰¦áˆ­á‹µ áˆ›á‹°áˆµ
      - name: "ğŸ“Š áˆªá–áˆ­á‰µ áˆ›á‹˜áŒ‹áŒ€á‰µ"
        if: always()
        run: |
          cat << 'EOF' > generate_dashboard.py
          import json, os, datetime
          
          os.makedirs('public', exist_ok=True)
          
          # áˆ˜áˆ¨áŒƒá‹áŠ• áˆ›áŠ•á‰ á‰¥
          try:
              with open('public/latest_stats.json', 'r') as f:
                  stats = json.load(f)
          except:
              stats = {"topic": "System Init", "revenue": 0, "quality": 0}
          
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Profit Master Autopilot</title>
              <meta charset="UTF-8">
              <style>
                  body {{ font-family: sans-serif; background: #0f172a; color: white; padding: 2rem; }}
                  .card {{ background: #1e293b; padding: 2rem; border-radius: 1rem; text-align: center; margin-top: 2rem; }}
                  .stat {{ font-size: 3rem; font-weight: bold; color: #38bdf8; }}
                  .label {{ color: #94a3b8; text-transform: uppercase; font-size: 0.9rem; }}
                  h1 {{ text-align: center; color: #e2e8f0; }}
              </style>
          </head>
          <body>
              <h1>ğŸš€ Profit Master Supreme - Autopilot</h1>
              <div class="card">
                  <div class="label">á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ áˆ­á‹•áˆµ</div>
                  <h2>{stats['topic']}</h2>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                      <div>
                          <div class="stat">${stats['revenue']}</div>
                          <div class="label">á‹¨á‰°áŒˆáˆ˜á‰° áŒˆá‰¢</div>
                      </div>
                      <div>
                          <div class="stat">{stats['quality']}%</div>
                          <div class="label">á‹¨áŒ¥áˆ«á‰µ á‹áŒ¤á‰µ</div>
                      </div>
                  </div>
                  <p style="margin-top: 20px; color: #64748b;">Last Run: {datetime.datetime.now()}</p>
              </div>
          </body>
          </html>
          """
          
          with open('public/index.html', 'w') as f:
              f.write(html)
          EOF
          
          python3 generate_dashboard.py

      # 6. á‹áŒ¤á‰±áŠ• áˆˆá‹“áˆˆáˆ á‹­á‹ áˆ›á‹µáˆ¨áŒ
      - name: "ğŸŒ á‹ˆá‹° GitHub Pages áˆ˜áˆ‹áŠ­"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true
          user_name: 'ProfitMasterBot'
          user_email: 'bot@profitmaster.ai'

      # 7. áˆˆáŒŒá‰³á‹ (áˆˆáŠ áŠ•á‰°) áˆªá–áˆ­á‰µ áˆ›á‹µáˆ¨áŒ
      - name: "ğŸ“² á‰ á‰´áˆŒáŒáˆ«áˆ áˆ›áˆ³á‹ˆá‰…"
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
        run: |
          cat << 'EOF' > notify.py
          import requests, os, json, sys
          
          token = os.getenv('TG_TOKEN')
          chat = os.getenv('TG_CHAT')
          
          if not token or not chat:
              print("âš ï¸ Telegram not configured")
              sys.exit(0)
              
          try:
              with open('public/latest_stats.json') as f:
                  stats = json.load(f)
                  
              repo = os.getenv('REPO').split('/')
              url = f"https://{repo[0]}.github.io/{repo[1]}/"
              
              msg = f"""
          ğŸ¤– *Profit Master Report*
          
          ğŸ“Œ *Topic:* {stats['topic']}
          ğŸ’° *Revenue:* ${stats['revenue']}
          â­ *Quality:* {stats['quality']}%
          
          ğŸ”— [View Dashboard]({url})
          """
              requests.post(f"https://api.telegram.org/bot{token}/sendMessage", 
                  json={'chat_id': chat, 'text': msg, 'parse_mode': 'Markdown'})
              print("âœ… Notification sent!")
          except Exception as e:
              print(f"âŒ Notification failed: {e}")
          EOF
          
          python3 notify.py
