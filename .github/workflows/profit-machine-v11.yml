name: ğŸ† PROFIT MACHINE v11.0 - Automated Content Generation

on:
  # 1. á‰ áˆ˜áŒá‰¢á‹« áŒˆáŒ½ (Dashboard) áˆ‹á‹­ áŠ«áˆˆá‹ á‰áˆá á‰ áˆ˜áŒ«áŠ•
  workflow_dispatch:
    inputs:
      topic:
        description: 'Article Topic (e.g., AI in Healthcare)'
        required: true
        default: 'AI in Business'
      country:
        description: 'Target Country'
        required: true
        default: 'US'
        type: choice
        options:
          - US
          - UK
          - DE
          - CA
          - AU
          - FR
          - JP
          - SG
          - CH
          - NL
      niche:
        description: 'Business Niche'
        required: true
        default: 'Technology'
        type: choice
        options:
          - Technology
          - Finance
          - Business
          - Health
          - Real Estate
          - Education
          - Marketing
      batch_size:
        description: 'Number of articles to generate'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '3'
          - '5'
          - '10'
  
  # 2. á‰ áˆ«áˆµ-áˆ°áˆ­ á‰ á‹¨á‰€áŠ‘ (á‹¨á‰°áˆˆá‹«á‹© áˆ°á‹“á‰¶á‰½)
  schedule:
    # á‰ á‹¨á‰€áŠ‘ á‰ á‰°áˆˆá‹«á‹© áˆ°á‹“á‰¶á‰½ (á‰  UTC)
    - cron: '0 8 * * *'   # á‰€áŠ• 8:00 AM (US áŠ¥áŠ•á‹²áˆ†áŠ•)
    - cron: '0 14 * * *'  # á‰€áŠ• 2:00 PM (EU áŠ¥áŠ•á‹²áˆ†áŠ•)
    - cron: '0 20 * * *'  # á‰€áŠ• 8:00 PM (Asia áŠ¥áŠ•á‹²áˆ†áŠ•)
  
  # 3. á‰ áŠ®á‹µ áˆˆá‹áŒ¥ áˆ²á‹°áˆ¨áŒ
  push:
    branches: [ main ]
    paths:
      - 'profit_machine_v11.py'
      - 'requirements.txt'
      - '.github/workflows/profit-machine-v11.yml'
  
  # 4. á‰ áŒ¥áˆ«á‰µ áŠ áˆµá‰°á‹³á‹°áˆ­ áŒ¥á‹«á‰„ áˆ²á‹°áˆ¨áŒ
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

# á‹¨áˆ›áŠ¨áŠ“á‹ˆáŠ• áˆá‰ƒá‹µ
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    # áˆˆáˆ›áŠ•áŠ›á‹áˆ á‹¨ API áˆµáˆ…á‰°á‰µ á‰°áˆˆá‹‹áŒ­ áŠ á‹«á‹«á‹
    continue-on-error: true
    
    # á‹¨áŠáŒ¥á‰¥ áŠ áˆµá‰°áˆ›áˆ›áŠáŠá‰µ áŠ¨á áŠ á‹µáˆ­áŒ
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      
      # áŠ¥á‹«áŠ•á‹³áŠ•á‹±áŠ• áˆ™áŠ¨áˆ« á‹¨á‰°áˆˆá‹¨ áˆˆá‹­
      fail-fast: false
    
    steps:
    # Step 1: áˆµáˆªá‰±áŠ• áŠ á‹áŒ£
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # Step 2: Python áŠ á‹˜áŒ‹áŒ…
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    # Step 3: áŒ¥áŒˆáŠ› á“áŠ¬áŒ†á‰½ áŒ«áŠ•
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # á‰°áŒ¨áˆ›áˆª á“áŠ¬áŒ†á‰½ á‹«áˆˆ requirements.txt
        pip install groq openai requests beautifulsoup4
        pip install matplotlib pillow
        pip install cryptography
    
    # Step 4: á‹¨ API á‰áˆáá‰½ áŠ á‹˜áŒ‹áŒ…
    - name: ğŸ” Setup API Keys
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        DALLE_API_KEY: ${{ secrets.DALLE_API_KEY }}
        STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
      run: |
        echo "API keys configured"
        # áˆˆáˆ›áˆ¨áŒ‹áŒˆáŒ«
        echo "GROQ_API_KEY exists: $([ -n \"$GROQ_API_KEY\" ] && echo 'Yes' || echo 'No')"
        echo "OPENAI_API_KEY exists: $([ -n \"$OPENAI_API_KEY\" ] && echo 'Yes' || echo 'No')"
    
    # Step 5: á‹¨áŒ½áˆá áˆ›áˆ˜áŠ•áŒ¨á‰µ
    - name: ğŸ¤– Generate Premium Content
      id: generate
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        DALLE_API_KEY: ${{ secrets.DALLE_API_KEY }}
        STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
      run: |
        # á‹¨áˆµáˆ« áˆ›áˆ…á‹°áˆ­ áŠ á‹˜áŒ‹áŒ…
        mkdir -p data
        mkdir -p exports
        mkdir -p logs
        
        # áŠ¨á‰€á‹¶ áŒ¥áŒˆáŠ“ áˆáŠ•áŒ­ á‹ˆá‹­áˆ á‰°áˆˆá‹‹áŒ­ áŠ¥áˆ´á‰¶á‰½
        TOPIC="${{ github.event.inputs.topic || 'AI Business Strategies' }}"
        COUNTRY="${{ github.event.inputs.country || 'US' }}"
        NICHE="${{ github.event.inputs.niche || 'Technology' }}"
        BATCH="${{ github.event.inputs.batch_size || '1' }}"
        
        # áˆˆ schedule áˆµáˆ« á‹¨á‹˜áˆá‰€á‹° áŠ¥áˆ´á‰¶á‰½ áˆáˆ¨áŒ¥
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "ğŸ“… Scheduled run detected - selecting random parameters"
          TOPICS=("AI in Healthcare" "Fintech Innovation" "Real Estate Investment" "E-commerce Growth" "Renewable Energy Business")
          COUNTRIES=("US" "UK" "DE" "CA" "AU")
          NICHES=("Technology" "Finance" "Business" "Health" "Real Estate")
          
          TOPIC=${TOPICS[$RANDOM % ${#TOPICS[@]}]}
          COUNTRY=${COUNTRIES[$RANDOM % ${#COUNTRIES[@]}]}
          NICHE=${NICHES[$RANDOM % ${#NICHES[@]}]}
          BATCH="1"
        fi
        
        echo "ğŸ¯ Parameters:"
        echo "  Topic: $TOPIC"
        echo "  Country: $COUNTRY"
        echo "  Niche: $NICHE"
        echo "  Batch: $BATCH"
        
        # á‹¨áŒ½áˆá áˆ›áˆ˜áŠ•áŒ¨á‰µ Python áˆµáŠ­áˆªá•á‰µ
        if [ "$BATCH" -gt "1" ]; then
          python3 profit_machine_v11.py --batch $BATCH --country $COUNTRY --niche $NICHE
        else
          python3 profit_machine_v11.py --single --topic "$TOPIC" --country $COUNTRY --niche $NICHE
        fi
        
        # á‹¨áˆ›áˆµáŒˆá‰¢á‹« á‰ á‹­áŠáŒˆáŒ½ áŠ¨áˆ†áŠ áŠ áŒ á‰ƒáˆ‹á‹­ á‹áŒ¤á‰µ áŠ áˆµáŒˆá‰£
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "summary=$(cat exports/summary.txt 2>/dev/null || echo 'Article generated successfully')" >> $GITHUB_OUTPUT
        fi
    
    # Step 6: á‹¨áˆšáˆ˜áŠáŒ©á‰µáŠ• á‹á‹­áˆá‰½ áŠ áˆµáŒˆá‰£
    - name: ğŸ’¾ Commit Generated Files
      if: always()
      run: |
        # á‹¨áˆšáˆ˜áŠáŒ©á‰µáŠ• á‹á‹­áˆá‰½ á‹ˆá‹° Git áŠ áˆµáŒˆá‰£
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # á‰ á‰€áŠ• áˆ˜áˆ áˆ¨á‰µ á‹¨ááˆá‹°áˆ­ ááŒ áˆ­
        DATE_FOLDER=$(date +'%Y/%m/%d')
        mkdir -p "generated/$DATE_FOLDER"
        
        # á‹¨áˆšáˆ˜áŠáŒ©á‰µáŠ• á‹á‹­áˆá‰½ á‹­áŒáˆˆáŒ¹
        if [ -d "exports" ]; then
          cp -r exports/* "generated/$DATE_FOLDER/" 2>/dev/null || true
        fi
        
        # áˆˆá‰³áˆªáŠ­ á‹¨áˆ›áŒ á‰ƒáˆˆá‹« á‹á‹­áˆ ááŒ áˆ­
        echo "# Generated Content - $(date)" > "generated/$DATE_FOLDER/README.md"
        echo "Generated on: $(date)" >> "generated/$DATE_FOLDER/README.md"
        echo "Topic: $TOPIC" >> "generated/$DATE_FOLDER/README.md"
        echo "Country: $COUNTRY" >> "generated/$DATE_FOLDER/README.md"
        echo "Niche: $NICHE" >> "generated/$DATE_FOLDER/README.md"
        
        # á‰ á‹¨áˆ°á‹“á‰± áˆ˜áˆ¨áŒƒ á‹á‹­áˆ ááŒ áˆ­
        HOURLY_FOLDER=$(date +'%Y/%m/%d/%H')
        mkdir -p "generated/$HOURLY_FOLDER"
        echo "Generated at $(date)" > "generated/$HOURLY_FOLDER/timestamp.txt"
        
        # á‹¨áˆšáˆˆá‹‹á‹ˆáŒ¡á‰µáŠ• á‹á‹­áˆá‰½ á‹ˆá‹° Git áŠ áˆµáŒˆá‰£
        git add -f generated/
        git add -f data/
        git add -f logs/
        
        # á‰°á‹ˆá‹³á‹³áˆª áˆˆá‹áŒ¥ áŠ«áˆˆ commit áŠ á‹µáˆ­áŒ
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Auto-generated content $(date +'%Y-%m-%d %H:%M:%S') [skip ci]"
          
          # á‹ˆá‹° áˆ›áŠ¨áˆ›á‰» áˆ‹áŠ­
          git push origin HEAD:main
        fi
    
    # Step 7: á‹¨áˆšáˆ˜áŠáŒ©á‰µáŠ• á‹á‹­áˆá‰½ áŠ¥áŠ•á‹° á‹¨áˆµáˆ« áˆáˆ­á‰µ áŠ áˆµá‰€áˆáŒ¥
    - name: ğŸ“¤ Upload Generated Files as Artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: generated-content-$(date +%Y%m%d-%H%M%S)
        path: |
          generated/
          exports/
          logs/
        retention-days: 30
    
    # Step 8: á‹ˆá‹° GitHub Pages áŠ áˆµá‰€áˆáŒ¥ (áˆˆáŒáˆ áˆ›áˆ³á‹«)
    - name: ğŸŒ Deploy to GitHub Pages
      if: success() && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./generated
        publish_branch: gh-pages
        destination_dir: ./content
        keep_files: false
    
    # Step 9: áˆ›áˆ³á‹ˆá‰‚á‹« áˆ‹áŠ­ (Discord/Slack/Email)
    - name: ğŸ“¢ Send Notification
      if: always()
      run: |
        STATUS="${{ job.status }}"
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # áˆˆ Discord Webhook
        if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"ğŸ¤– **Profit Machine v11.0**\\nStatus: ${STATUS}\\nRun: ${RUN_URL}\\nTopic: ${TOPIC}\\nCountry: ${COUNTRY}\"}" \
               "${{ secrets.DISCORD_WEBHOOK }}"
        fi
        
        # áˆˆ Slack Webhook
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
               --data "{\"text\":\"ğŸ¤– Profit Machine v11.0 - ${STATUS}\\n<${RUN_URL}|View Run>\"}" \
               "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

  # áˆŒáˆ‹ áˆµáˆ«: á‹¨áŒˆá‰¢ áˆªá–áˆ­á‰µ áŠ¥áŠ“ á‰µáŠ•á‰³áŠ”
  revenue-report:
    runs-on: ubuntu-latest
    needs: generate-content
    if: always() && needs.generate-content.result == 'success'
    
    steps:
    - name: ğŸ“¥ Download Generated Artifacts
      uses: actions/download-artifact@v3
      with:
        name: generated-content-$(date +%Y%m%d-%H%M%S)
        path: ./artifacts
    
    - name: ğŸ“Š Generate Revenue Report
      run: |
        # á‹¨áŒˆá‰¢ áˆªá–áˆ­á‰µ áˆµáŠ­áˆªá•á‰µ
        python3 generate_revenue_report.py
        
        # áˆ›áŒ á‰ƒáˆˆá‹« á‹á‹­áˆ ááŒ áˆ­
        echo "# Daily Revenue Report - $(date)" > revenue-summary.md
        echo "Total Articles: $(find artifacts -name '*.json' | wc -l)" >> revenue-summary.md
        echo "Estimated Monthly Revenue: \$" >> revenue-summary.md
        cat revenue-summary.md
    
    - name: ğŸ“ˆ Upload Report
      uses: actions/upload-artifact@v3
      with:
        name: revenue-report-$(date +%Y%m%d)
        path: revenue-summary.md

  # áˆŒáˆ‹ áˆµáˆ«: á‹¨áŒ¥áˆ«á‰µ á‰áŒ¥áŒ¥áˆ­
  quality-check:
    runs-on: ubuntu-latest
    needs: generate-content
    if: always()
    
    steps:
    - name: ğŸ” Quality Assurance Check
      run: |
        # á‹¨ SEO áŠáŒ¥á‰¥ áŠ­á‰µá‰µáˆ
        python3 quality_check.py
        
        # á‹¨á‹­á‹˜á‰µ áŒ¥áˆ«á‰µ áŠ­á‰µá‰µáˆ
        echo "Quality checks completed"
        
        # áˆ›áˆµá‰°áŠ«áŠ¨á‹« áˆáŠ­áˆ®á‰½
        echo "Recommendations will be added to next run"
    
    - name: ğŸ¯ Set Quality Score
      run: |
        echo "QUALITY_SCORE=85" >> $GITHUB_ENV
