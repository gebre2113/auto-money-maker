name: Profit Master Supreme v11.0

on:
  # рЅарѕЂрѕѕрЅх рѕўріЋрїѕрІх рѕірѕарѕФ рІГрЅйрѕІрѕЇ:
  # 1. рЅаріЦрїЁ (рЅаGitHub рІЇрѕхрїЦ рЅарѕўрїФріЋ)
  workflow_dispatch:
    inputs:
      mode:
        description: 'рѕЮрѕГрїФ рІФрІхрѕГрїЅ'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - cli
        - report
        - setup
      topic:
        description: 'рІерѕџрЇѕрѕѕрїѕрІЇ рѕГрІЋрѕх (рѕѕauto mode рЅБрІХ рІГрЅ░рІЇ)'
        required: false
        default: ''
        type: string
      category:
        description: 'рѕЮрІхрЅЦ'
        required: false
        default: 'technology'
        type: choice
        options:
        - technology
        - business
        - finance
        - health
        - education
        - marketing
  
  # 2. рЅарѕФрѕх-рѕ░рѕГ рЅарІерЅђріЉ рЅа08:00 UTC
  schedule:
    - cron: '0 8 * * *'

env:
  PYTHON_VERSION: '3.11'
  MIN_WORD_COUNT: '2500'
  ARTICLES_PER_DAY: '3'

jobs:
  profit-master:
    runs-on: ubuntu-latest
    
    steps:
    - name: ­ЪЊЦ рѕфрЇќрІЮрЅХрѕф ріарѕЮрїБ
      uses: actions/checkout@v3
    
    - name: ­ЪљЇ Python ріарЅІрЅЂрѕЮ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ­ЪЊд рІерЇЊрІГрЅХріЋ рїЦрїѕріЏрІјрЅй рїФріЋ
      run: |
        python -m pip install --upgrade pip
        pip install groq requests tweepy facebook-sdk Pillow schedule
        pip install pytrends pandas plotly streamlit streamlit-option-menu
    
    - name: ­ЪЊЂ рІерѕџрІФрѕхрЇѕрѕЇрїЅ рІ│рІГрѕгріГрЅХрѕфрІјрЅйріЋ рЇЇрїарѕГ
      run: |
        mkdir -p data images backups exports reports
        echo "­ЪЊЂ рІ│рІГрѕгріГрЅХрѕфрІјрЅй рЅ░рЇѕрїЦрѕерІІрѕЇ"
    
    - name: ­ЪћД рІеріарѕ░рѕФрѕГ рѕўрѕѕріфрІФрІјрЅйріЋ ріарѕхрїѕрЅБ
      run: |
        echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> $GITHUB_ENV
        echo "WP_URL=${{ secrets.WP_URL }}" >> $GITHUB_ENV
        echo "WP_USERNAME=${{ secrets.WP_USERNAME }}" >> $GITHUB_ENV
        echo "WP_PASSWORD=${{ secrets.WP_PASSWORD }}" >> $GITHUB_ENV
        echo "TWITTER_API_KEY=${{ secrets.TWITTER_API_KEY }}" >> $GITHUB_ENV
        echo "TWITTER_API_SECRET=${{ secrets.TWITTER_API_SECRET }}" >> $GITHUB_ENV
        echo "TWITTER_ACCESS_TOKEN=${{ secrets.TWITTER_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "TWITTER_ACCESS_SECRET=${{ secrets.TWITTER_ACCESS_SECRET }}" >> $GITHUB_ENV
        echo "FACEBOOK_ACCESS_TOKEN=${{ secrets.FACEBOOK_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "FACEBOOK_PAGE_ID=${{ secrets.FACEBOOK_PAGE_ID }}" >> $GITHUB_ENV
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> $GITHUB_ENV
        echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> $GITHUB_ENV
        echo "STABILITY_API_KEY=${{ secrets.STABILITY_API_KEY }}" >> $GITHUB_ENV
        echo "UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY }}" >> $GITHUB_ENV
        echo "ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}" >> $GITHUB_ENV
        echo "GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}" >> $GITHUB_ENV
        
        # рІерїЇрЅЦрІБ рѕЏрѕ╗рѕ╗рІФрІјрЅй
        echo "ENABLE_GROQ_AI=true" >> $GITHUB_ENV
        echo "ENABLE_WORDPRESS=true" >> $GITHUB_ENV
        echo "ENABLE_SOCIAL_MEDIA=true" >> $GITHUB_ENV
        echo "ENABLE_AI_IMAGES=true" >> $GITHUB_ENV
        echo "ENABLE_AFFILIATE_MONETIZATION=true" >> $GITHUB_ENV
        echo "ENABLE_AUTO_SCHEDULING=true" >> $GITHUB_ENV
        echo "ENABLE_TRENDING_TOPICS=true" >> $GITHUB_ENV
    
    - name: ­Ъџђ Profit Master Supreme ріарѕѓрІх
      id: run_profit_master
      run: |
        echo "­ЪЈЂ Profit Master Supreme v11.0 рѕірѕарѕФ рїђрѕЮрѕ»рѕЇ..."
        echo "­ЪЊЁ рЅђріЋ: $(date)"
        echo "­ЪћД рѕърІх: ${{ github.event.inputs.mode || 'auto' }}"
        echo "­ЪЊЮ рѕГрІЋрѕх: ${{ github.event.inputs.topic || 'Auto-generated from trends' }}"
        echo "­ЪЈи№ИЈ рѕЮрІхрЅЦ: ${{ github.event.inputs.category || 'technology' }}"
        
        # рѕхріГрѕфрЇЋрЅх рѕхрѕЮ ріЦріЋрІ░ ріаріФрЅБрЅбрІј рІГрѕѕрІЇрїА
        SCRIPT_NAME="profit_master_supreme.py"
        
        if [ -f "$SCRIPT_NAME" ]; then
          echo "РюЁ $SCRIPT_NAME рЅ░рїѕріЮрЅирѕЇ"
        elif [ -f "profit_machine_v9.py" ]; then
          SCRIPT_NAME="profit_machine_v9.py"
          echo "РюЁ $SCRIPT_NAME (v9.7) рЅ░рїѕріЮрЅирѕЇ"
        elif [ -f "profit_master.py" ]; then
          SCRIPT_NAME="profit_master.py"
          echo "РюЁ $SCRIPT_NAME рЅ░рїѕріЮрЅирѕЇ"
        else
          echo "РЮї рѕЮріЋрѕЮ рІеProfit Master рѕхріГрѕфрЇЋрЅх ріарѕЇрЅ░рїѕріўрѕЮ"
          exit 1
        fi
        
        # рІерѕџрѕарѕФрЅарЅхріЋ рѕърІх рІГрІѕрѕхріЉ
        MODE="${{ github.event.inputs.mode || 'auto' }}"
        
        if [ "$MODE" = "auto" ]; then
          echo "­Ъцќ рЅарѕФрѕх-рѕ░рѕГ рѕърІх рЅарѕўрѕарѕФрЅх рѕІрІГ..."
          python $SCRIPT_NAME --auto
          EXIT_CODE=$?
        elif [ "$MODE" = "cli" ]; then
          echo "­Ъњ╗ рЅарЅхрІЋрІЏрІЮ рѕўрѕхрѕўрѕГ рѕърІх рЅарѕўрѕарѕФрЅх рѕІрІГ..."
          TOPIC="${{ github.event.inputs.topic }}"
          CATEGORY="${{ github.event.inputs.category || 'technology' }}"
          
          if [ -z "$TOPIC" ]; then
            echo "РЮї рѕѕCLI рѕърІх рѕГрІЋрѕх рІФрѕхрЇѕрѕЇрїІрѕЇ"
            exit 1
          fi
          
          # рі«рІ▒ріЋ рЅарЅђрїЦрЅ│ рѕѕрѕЏрѕхрЇѕрЇђрѕЮ рѕЮрЅхріГ рі«рІх
          python3 << 'EOF'
import os
import sys
import json
from datetime import datetime

# рі«ріЋрЇірїЇ рІГрЇЇрїарѕЕ
config = {
    'GROQ_API_KEY': os.getenv('GROQ_API_KEY', ''),
    'WP_URL': os.getenv('WP_URL', ''),
    'WP_USERNAME': os.getenv('WP_USERNAME', ''),
    'WP_PASSWORD': os.getenv('WP_PASSWORD', ''),
    'TWITTER_API_KEY': os.getenv('TWITTER_API_KEY', ''),
    'TWITTER_API_SECRET': os.getenv('TWITTER_API_SECRET', ''),
    'TWITTER_ACCESS_TOKEN': os.getenv('TWITTER_ACCESS_TOKEN', ''),
    'TWITTER_ACCESS_SECRET': os.getenv('TWITTER_ACCESS_SECRET', ''),
    'FACEBOOK_ACCESS_TOKEN': os.getenv('FACEBOOK_ACCESS_TOKEN', ''),
    'FACEBOOK_PAGE_ID': os.getenv('FACEBOOK_PAGE_ID', ''),
    'ENABLE_GROQ_AI': True,
    'ENABLE_WORDPRESS': bool(os.getenv('WP_URL')),
    'ENABLE_SOCIAL_MEDIA': bool(os.getenv('TWITTER_API_KEY')),
    'MIN_WORD_COUNT': 2500,
    'ARTICLES_PER_DAY': 3
}

topic = "$TOPIC"
category = "$CATEGORY"

print(f"­Ъј» рѕГрІЋрѕх: {topic}")
print(f"­ЪЈи№ИЈ рѕЮрІхрЅЦ: {category}")
print(f"­ЪћЉ GROQ API: {'РюЁ ріарѕѕ' if config['GROQ_API_KEY'] else 'РЮї рІерѕѕрѕЮ'}")
print(f"­Ъїљ WordPress: {'РюЁ ріарѕѕ' if config['ENABLE_WORDPRESS'] else 'РЮї рІерѕѕрѕЮ'}")
print(f"­ЪЊ▒ Social Media: {'РюЁ ріарѕѕ' if config['ENABLE_SOCIAL_MEDIA'] else 'РЮї рІерѕѕрѕЮ'}")

# ріарѕЂріЋ рІФрѕѕрІјрЅхріЋ рі«рІх рІГрїарЅђрѕЎ
try:
    # рІГрѕЁріЋріЋ рІГрѕѕрІЇрїА рЅаріЦрѕГрѕхрІј ріЦрІЇріљрЅ░ріЏ рі«рІх
    exec(open("$SCRIPT_NAME").read())
except Exception as e:
    print(f"РЮї рѕхрѕЁрЅ░рЅх: {e}")
EOF
          EXIT_CODE=$?
        elif [ "$MODE" = "report" ]; then
          echo "­ЪЊі рѕфрЇќрѕГрЅх рЅарѕўрЇЇрїарѕГ рѕІрІГ..."
          python $SCRIPT_NAME --report
          EXIT_CODE=$?
        elif [ "$MODE" = "setup" ]; then
          echo "­ЪћД рѕЏрѕ░ріЊрІ│рЅх рѕўрѕўрѕфрІФрІјрЅйріЋ рЅарѕЏрѕ│рІерЅх рѕІрІГ..."
          python $SCRIPT_NAME --setup
          EXIT_CODE=$?
        else
          echo "РЮї рІерЅ░рѕ│рѕ│рЅ░ рѕърІх: $MODE"
          exit 1
        fi
        
        # рІЇрїцрЅ▒ріЋ ріарѕхрЇЇрѕерІЇ
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "РюЁ Profit Master рЅарЅ░рѕ│ріФ рѕЂріћрЅ│ рЅ░рЇѕрїйрѕЪрѕЇ!"
        else
          echo "РЮї Profit Master рЅарѕхрѕЁрЅ░рЅх рїѕрІ░рЅа!"
        fi
    
    - name: ­ЪЊѓ рІЇрїцрЅХрЅйріЋ ріарѕхрЅђрѕЮрїЦ
      if: always()
      run: |
        echo "­ЪЊЂ рІерЅ░рЇѕрїарѕЕ рЇІрІГрѕјрЅйріЋ ріЦрІерЅ░рѕўрѕѕріерЅ░ ріљрІЇ..."
        ls -la data/ 2>/dev/null || echo "­ЪЊЂ рІерІЇрѕѓрЅЦ рІ│рІГрѕгріГрЅХрѕф ріарѕЇрЅ░рЇѕрїарѕерѕЮ"
        ls -la images/ 2>/dev/null || echo "­ЪЊЂ рІерѕЮрѕхрѕЇ рІ│рІГрѕгріГрЅХрѕф ріарѕЇрЅ░рЇѕрїарѕерѕЮ"
        ls -la reports/ 2>/dev/null || echo "­ЪЊЂ рІерѕфрЇќрѕГрЅх рІ│рІГрѕгріГрЅХрѕф ріарѕЇрЅ░рЇѕрїарѕерѕЮ"
        
        # рІерІЇрѕѓрЅЦ рїјрЅ│ рІЇрѕѓрЅЦ рѕѕрѕЏрІерЅх
        if [ -f "data/profit_master.db" ]; then
          echo "­ЪЌё№ИЈ рІерІЇрѕѓрЅЦ рїјрЅ│ рѕўрїаріЋ: $(du -h data/profit_master.db | cut -f1)"
          echo "­ЪЊі рІерІЇрѕѓрЅЦ рїјрЅ│ рІГрІўрЅх:"
          python3 << 'EOF'
import sqlite3
import os

db_path = "data/profit_master.db"
if os.path.exists(db_path):
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # рІеріарѕГрЅ▓ріГрѕјрЅй рЅЦрІЏрЅх
    cursor.execute("SELECT COUNT(*) FROM articles")
    article_count = cursor.fetchone()[0]
    print(f"­ЪЊЮ ріарїарЅЃрѕІрІГ ріарѕГрЅ▓ріГрѕјрЅй: {article_count}")
    
    # рІеріарѕГрЅ▓ріГрѕјрЅй рЅЦрІЏрЅх (Pro)
    cursor.execute("SELECT COUNT(*) FROM articles_pro")
    article_pro_count = cursor.fetchone()[0]
    print(f"­ЪЊЮ Pro ріарѕГрЅ▓ріГрѕјрЅй: {article_pro_count}")
    
    # рІерЅ░рїѕрѕўрЅ░ рїѕрЅб
    cursor.execute("SELECT SUM(estimated_revenue) FROM articles_pro")
    total_revenue = cursor.fetchone()[0] or 0
    print(f"­Ъњ░ ріарїарЅЃрѕІрІГ рІерЅ░рїѕрѕўрЅ░ рїѕрЅб: ${total_revenue:.2f}")
    
    conn.close()
else:
    print("РЮї рІерІЇрѕѓрЅЦ рїјрЅ│ ріарѕЇрЅ░рїѕріўрѕЮ")
EOF
        fi
    
    - name: ­ЪЊД рІЇрїцрЅ▒ріЋ рѕІріГ
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const mode = context.payload.inputs?.mode || 'auto';
          const topic = context.payload.inputs?.topic || 'Auto-generated';
          const category = context.payload.inputs?.category || 'technology';
          const exitCode = ${{ steps.run_profit_master.outputs.exit_code }};
          
          const success = exitCode === 0;
          const status = success ? 'РюЁ рЅ░рѕ│ріГрЅирѕЇ' : 'РЮї ріарѕЇрЅ░рѕ│ріФрѕЮ';
          
          // рІеріарѕ░рѕФрѕГ рѕфрЇќрѕГрЅх рЇЇрїарѕГ
          const report = `
          # Profit Master Supreme v11.0 - рІеріарѕ░рѕФрѕГ рѕфрЇќрѕГрЅх
          
          ## ­ЪЊі рІЇрїцрЅх
          - **рѕЂріћрЅ│:** ${status}
          - **рѕърІх:** ${mode}
          - **рѕГрІЋрѕх:** ${topic}
          - **рѕЮрІхрЅЦ:** ${category}
          - **рїірІю:** ${new Date().toLocaleString()}
          - **рІерІЇрїцрЅх рі«рІх:** ${exitCode}
          
          ## ­ЪћЌ рѕЏрїѕріЊріЏрІјрЅй
          - [рІеріарѕ░рѕФрѕГ рѕЮрІЮрїѕрЅБ](https://github.com/${context.repo.owner}/${context.repo.name}/actions/runs/${context.runId})
          - [рѕфрЇќрІЮрЅХрѕф](https://github.com/${context.repo.owner}/${context.repo.name})
          
          ## ­ЪЊѕ рѕѕрѕџрЅђрїЦрѕѕрІЇ ріЦрѕГрѕЮрїЃ
          ${success ? 'РюЁ рЅђрїБрІЕріЋ ріарѕ░рѕФрѕГ рІФрЅђріЊрЅЦрѕЕ!' : 'Рџа№ИЈ ріарѕ░рѕФрѕЕріЋ рІГрѕўрѕЇріерЅ▒ ріЦріЊ рѕхрѕЁрЅ░рЅХрЅйріЋ рІФрѕГрѕЎ!'}
          `;
          
          // рЅа GitHub ріарѕ░рѕФрѕГ рІЇрѕхрїЦ ріарѕхрЅ░рІФрІерЅх ріарѕхрЅђрѕЮрїЦ
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue?.number || context.payload.workflow_run?.pull_requests?.[0]?.number || 0,
            body: report
          }).catch(() => {
            // ріарѕхрЅ░рІФрІерЅх ріФрѕЇрЅ░рѕ│ріФ рЅйрѕІ рЅарѕЇ
            console.log('ріарѕхрЅ░рІФрІерЅх рѕЏрѕхрЅђрѕўрїЦ ріарѕЇрЅ░рЅ╗рѕѕрѕЮ');
          });
          
          // рѕѕрѕфрЇќрІЮрЅХрѕф рІ░рѕФрѕ▓рІјрЅй рѕЏрѕ│рІѕрЅѓрІФ рѕІріГ (ріерЇѕрѕѕрїЅ)
          if (!success) {
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'profit_master.yml',
              ref: context.ref,
              inputs: {
                mode: 'report',
                topic: 'System Check',
                category: 'technology'
              }
            });
          }

  backup:
    runs-on: ubuntu-latest
    needs: profit-master
    if: always()
    
    steps:
    - name: ­ЪЊЦ рѕфрЇќрІЮрЅХрѕф ріарѕЮрїБ
      uses: actions/checkout@v3
    
    - name: ­ЪЊд рІерІЇрѕѓрЅЦ рїјрЅ│ рІФрѕерїІрїЇрїА
      run: |
        if [ -f "data/profit_master.db" ]; then
          echo "­ЪЌё№ИЈ рІерІЇрѕѓрЅЦ рїјрЅ│ ріарѕѕ"
          echo "­ЪЊЈ рѕўрїаріЋ: $(du -h data/profit_master.db | cut -f1)"
          
          # рІерІЇрѕѓрЅЦ рїјрЅ│ріЋ рІФрѕерїІрїЇрїА
          python3 << 'EOF'
import sqlite3
import os
import json

db_path = "data/profit_master.db"
if os.path.exists(db_path):
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # рѕ░ріЋрїарѕерІдрЅйріЋ рІФрѕерїІрїЇрїА
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = cursor.fetchall()
        
        print(f"­ЪЊІ рІерѕ░ріЋрїарѕерІдрЅй рЅЦрІЏрЅх: {len(tables)}")
        for table in tables:
            cursor.execute(f"SELECT COUNT(*) FROM {table[0]}")
            count = cursor.fetchone()[0]
            print(f"  - {table[0]}: {count} рѕерІхрЇјрЅй")
        
        conn.close()
        print("РюЁ рІерІЇрѕѓрЅЦ рїјрЅ│ рІ░рѕЁріЊ ріљрІЇ")
    except Exception as e:
        print(f"РЮї рІерІЇрѕѓрЅЦ рїјрЅ│ рѕхрѕЁрЅ░рЅх: {e}")
else:
    print("Рџа№ИЈ рІерІЇрѕѓрЅЦ рїјрЅ│ ріарѕЇрЅ░рїѕріўрѕЮ")
EOF
        else
          echo "Рџа№ИЈ рІерІЇрѕѓрЅЦ рїјрЅ│ ріарѕЇрЅ░рїѕріўрѕЮ"
        fi
    
    - name: ­ЪњЙ рІерІЇрѕѓрЅЦ рїјрЅ│ рЅ░рЅєрїБрїБрѕф рЇЇрїарѕГ
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_DIR="backups"
        
        # рІерІЇрѕѓрЅЦ рїјрЅ│ріЋ рЅЁрїѓ рІФрІхрѕГрїЅ
        if [ -f "data/profit_master.db" ]; then
          mkdir -p $BACKUP_DIR
          cp data/profit_master.db "$BACKUP_DIR/profit_master_${TIMESTAMP}.db"
          echo "­ЪњЙ рІерІЇрѕѓрЅЦ рїјрЅ│ рЅ░рЅєрїБрїБрѕф рЅ░рЇѕрїЦрѕ»рѕЇ: $BACKUP_DIR/profit_master_${TIMESTAMP}.db"
          
          # рІерЅ░рЇѕрїарѕЕрЅхріЋ рЅ░рЅєрїБрїБрѕфрІјрЅй рІГрЅЂрїарѕЕ
          BACKUP_COUNT=$(ls -1 $BACKUP_DIR/*.db 2>/dev/null | wc -l)
          echo "­ЪЊі ріарїарЅЃрѕІрІГ рЅ░рЅєрїБрїБрѕфрІјрЅй: $BACKUP_COUNT"
          
          # 10 рЅарѕІрІГ ріерѕєріЉ рїЦріЋрІХрЅ╣ріЋ рІФрїЦрЇЅ
          if [ $BACKUP_COUNT -gt 10 ]; then
            echo "­ЪД╣ рїЦріЋрІх рЅ░рЅєрїБрїБрѕфрІјрЅйріЋ ріЦрІерїарЇІ ріљрІЇ..."
            ls -1t $BACKUP_DIR/*.db | tail -n +11 | xargs rm -f
            echo "РюЁ рїЦріЋрІх рЅ░рЅєрїБрїБрѕфрІјрЅй рїарЇЇрЅ░рІІрѕЇ"
          fi
        else
          echo "Рџа№ИЈ рІерІЇрѕѓрЅЦ рїјрЅ│ рѕѕрЅ░рЅєрїБрїБрѕф ріарѕЇрЅ░рїѕріўрѕЮ"
        fi
    
    - name: ­ЪЊц рЅ░рЅєрїБрїБрѕфрІјрЅйріЋ рІѕрІ░ ріарѕГрЅ▓рЇІріГрЅх рѕІріГ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: profit-master-backup-${{ github.run_id }}
        path: |
          backups/
          data/profit_master.db
        retention-days: 7
