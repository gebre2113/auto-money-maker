name: Profit Master Executor - Auto Find & Fix

on:
  schedule:
    - cron: '0 */6 * * *'   # ·â†·ã®6 ·à∞·ãì·â±
    - cron: '30 12 * * *'   # ·â†·ã®·âÄ·äë 12:30
  workflow_dispatch:        # ·â†·ä•·åÖ ·àõ·àµ·ä¨·åÉ
    inputs:
      operation_type:
        description: 'Operation Mode'
        required: true
        default: 'full-cycle'
        type: choice
        options:
        - full-cycle
        - content-only
        - report-only

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==================== JOB 1: EXECUTION ENGINE ====================
  execute_engine:
    runs-on: ubuntu-latest
    name: "üöÄ Execute Profit Master"
    timeout-minutes: 60
    
    steps:
      # 1. ·äÆ·ãµ ·àõ·ãç·à®·ãµ
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      # 2. Python ·àõ·ãò·åã·åÄ·âµ
      - name: "üêç Setup Python 3.10"
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. ·å•·åà·äû·âΩ·äï (Dependencies) ·àò·å´·äï
      - name: "üì¶ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests schedule plotly streamlit
          pip install groq tweepy facebook-sdk python-telegram-bot
          pip install beautifulsoup4 lxml Pillow
          pip install sqlalchemy streamlit-option-menu
          echo "‚úÖ Dependencies installed successfully"

      # 4. ·ã®·àµ·à´ ·àõ·ãç·å´ ·àõ·ãò·åã·åÄ·âµ
      - name: "üìÇ Prepare Workspace"
        run: |
          mkdir -p data images reports public
          echo "Workspace ready"

      # 5. Profit Master ·àµ·ä≠·à™·çï·âµ·äï ·çà·àç·åé ·àõ·àµ·ä¨·ãµ (Auto-Find Fix)
      - name: "ü§ñ Run Profit Master Script"
        id: run_script
        env:
          # ·àÅ·àâ·àù ·àö·àµ·å•·à´·ãä ·âÅ·àç·çé·âΩ
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
          WP_URL: ${{ secrets.WP_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
          OPERATION: ${{ github.event.inputs.operation_type || 'full-cycle' }}
        run: |
          echo "üîç Searching for Profit Master script..."
          
          # ·çã·ã≠·àâ·äï ·â†·å†·âÖ·àã·àã Repo ·ãç·àµ·å• ·àò·çà·àà·åç (Case Insensitive)
          SCRIPT_PATH=$(find . -iname "profit_master_supreme.py" -o -iname "main.py" | head -n 1)
          
          if [ -z "$SCRIPT_PATH" ]; then
            echo "‚ùå CRITICAL ERROR: Could not find 'profit_master_supreme.py' or 'main.py'!"
            echo "üìÇ Files in repository:"
            ls -R
            exit 1
          fi
          
          echo "‚úÖ Found script at: $SCRIPT_PATH"
          echo "üöÄ Executing in [$OPERATION] mode..."
          
          if [ "$OPERATION" == "report-only" ]; then
            python3 -u "$SCRIPT_PATH" --report
          else
            python3 -u "$SCRIPT_PATH" --auto
          fi
          
          echo "‚úÖ Execution finished."

      # 6. ·ã®·ã≥·àΩ·â¶·à≠·ãµ HTML ·àõ·àò·äï·å®·âµ (Fallback)
      - name: "üìä Generate Static Dashboard"
        if: always()
        run: |
          cat << 'EOF' > generate_dashboard.py
          import sqlite3, os, datetime
          
          db_path = 'data/profit_master.db'
          stats = {'articles': 0, 'revenue': 0.0}
          
          if os.path.exists(db_path):
              try:
                  conn = sqlite3.connect(db_path)
                  cursor = conn.cursor()
                  try:
                      cursor.execute("SELECT COUNT(*) FROM articles_pro")
                      stats['articles'] = cursor.fetchone()[0]
                      cursor.execute("SELECT SUM(estimated_revenue) FROM articles_pro")
                      stats['revenue'] = cursor.fetchone()[0] or 0.0
                  except: pass
                  conn.close()
              except: pass

          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Profit Master Dashboard</title>
              <style>
                  body {{ font-family: sans-serif; background: #f0f2f5; padding: 40px; text-align: center; }}
                  .card {{ background: white; padding: 30px; border-radius: 15px; display: inline-block; margin: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 250px; }}
                  h1 {{ color: #1a73e8; }}
                  .num {{ font-size: 40px; font-weight: bold; color: #333; }}
              </style>
          </head>
          <body>
              <h1>üöÄ Profit Master Supreme</h1>
              <p>Last Update: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}</p>
              <div>
                  <div class="card">
                      <div class="num">{stats['articles']}</div>
                      <div>Articles Generated</div>
                  </div>
                  <div class="card">
                      <div class="num">${stats['revenue']:.2f}</div>
                      <div>Estimated Revenue</div>
                  </div>
              </div>
          </body>
          </html>
          """
          
          os.makedirs('public', exist_ok=True)
          with open('public/index.html', 'w') as f:
              f.write(html)
          EOF
          
          python3 generate_dashboard.py

      # 7. ·ãç·å§·â±·äï ·ãà·ã∞ GitHub Pages ·àò·àç·âÄ·âÖ
      - name: "üåê Deploy to GitHub Pages"
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      # 8. ·äñ·â≤·çä·ä¨·àΩ·äï ·àò·àã·ä≠
      - name: "üì≤ Send Notifications"
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          STATUS: ${{ job.status }}
        run: |
          cat << 'EOF' > notify.py
          import requests, os, sys

          status = os.getenv('STATUS')
          tg_token = os.getenv('TG_TOKEN')
          tg_chat = os.getenv('TG_CHAT')
          
          repo = os.getenv('REPO').split('/')
          dashboard = f"https://{repo[0]}.github.io/{repo[1]}/"
          
          if tg_token and tg_chat:
              icon = "‚úÖ" if status == "success" else "‚ùå"
              msg = f"{icon} *Profit Master Run*\nStatus: {status.upper()}\nüîó [View Dashboard]({dashboard})"
              try:
                  requests.post(
                      f"https://api.telegram.org/bot{tg_token}/sendMessage",
                      json={"chat_id": tg_chat, "text": msg, "parse_mode": "Markdown"}
                  )
                  print("Telegram sent.")
              except: pass
          EOF
          
          python3 notify.py

      # 9. Artifacts ·àõ·àµ·âÄ·àò·å•
      - name: "üíæ Upload Logs & Data"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-data
          path: |
            data/
            public/
          retention-days: 7
