name: Profit Master Executor - Enterprise Edition

on:
  schedule:
    - cron: '0 */6 * * *'   # ·â†·ã®6 ·à∞·ãì·â±
    - cron: '30 12 * * *'   # ·â†·ã®·âÄ·äë 12:30
  workflow_dispatch:        # ·â†·ä•·åÖ ·àõ·àµ·ä¨·åÉ
    inputs:
      operation_type:
        description: 'Operation Mode'
        required: true
        default: 'full-cycle'
        type: choice
        options:
        - full-cycle
        - content-only
        - social-only
        - report-only

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==================== JOB 1: ENVIRONMENT CHECK ====================
  security_check:
    runs-on: ubuntu-latest
    name: "üîí Security & Environment Check"
    outputs:
      env_status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: "üîç Check Secrets"
        id: check
        env:
          GROQ: ${{ secrets.GROQ_API_KEY }}
          TG_BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          if [ -z "$GROQ" ]; then
            echo "‚ö†Ô∏è WARNING: GROQ_API_KEY is missing. AI features may fail."
          else
            echo "‚úÖ Groq API Key found."
          fi
          echo "status=checked" >> $GITHUB_OUTPUT

  # ==================== JOB 2: EXECUTION ENGINE ====================
  execute_engine:
    needs: security_check
    runs-on: ubuntu-latest
    name: "üöÄ Execute Profit Master Engine"
    timeout-minutes: 60
    
    steps:
      # 1. ·äÆ·ãµ ·àõ·ãç·à®·ãµ
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      # 2. Python ·àõ·ãò·åã·åÄ·âµ
      - name: "üêç Setup Python 3.10"
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. ·å•·åà·äû·âΩ·äï (Dependencies) ·àò·å´·äï
      - name: "üì¶ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          # ·ã®·çì·ã≠·â∞·äï ·àµ·ä≠·à™·çï·âµ·àÖ ·ã®·àö·çà·àç·åã·â∏·ãç ·àÅ·àâ·àù ·çì·ä¨·åÜ·âΩ
          pip install pandas numpy requests schedule plotly streamlit
          pip install groq tweepy facebook-sdk python-telegram-bot
          pip install beautifulsoup4 lxml Pillow
          pip install sqlalchemy streamlit-option-menu
          echo "‚úÖ Dependencies installed successfully"

      # 4. ·ã®·àµ·à´ ·àõ·ãç·å´ ·àõ·ãò·åã·åÄ·âµ
      - name: "üìÇ Prepare Workspace"
        run: |
          mkdir -p data images reports public
          echo "Workspace ready"

      # 5. Profit Master ·àµ·ä≠·à™·çï·âµ·äï ·àõ·àµ·ä¨·ãµ
      - name: "ü§ñ Run Profit Master Script"
        id: run_script
        env:
          # ·àÅ·àâ·àù ·àö·àµ·å•·à´·ãä ·âÅ·àç·çé·âΩ
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
          WP_URL: ${{ secrets.WP_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
          # ·àõ·àµ·ä¨·åÉ ·àò·àà·ä™·ã´·ãé·âΩ
          OPERATION: ${{ github.event.inputs.operation_type || 'full-cycle' }}
        run: |
          echo "üöÄ Executing Profit Master in [$OPERATION] mode..."
          
          # ·àµ·ä≠·à™·çï·â± ·â†·àµ·à≠·ä†·âµ ·àò·äñ·à©·äï ·àõ·à®·åã·åà·å•
          if [ -f "profit_master_supreme.py" ]; then
            SCRIPT="profit_master_supreme.py"
          elif [ -f "main.py" ]; then
            SCRIPT="main.py"
          else
            echo "‚ùå Error: Main script not found!"
            exit 1
          fi
          
          # ·ä•·äï·ã∞ ·àù·à≠·å´·ãç ·àõ·ãò·ã£ ·àò·àµ·å†·âµ
          if [ "$OPERATION" == "report-only" ]; then
            python3 -u $SCRIPT --report
          else
            python3 -u $SCRIPT --auto
          fi
          
          echo "‚úÖ Execution finished."

      # 6. ·ã®·ã≥·àΩ·â¶·à≠·ãµ HTML ·àõ·àò·äï·å®·âµ (·àµ·ä≠·à™·çï·âµ·àÖ ·à´·à± ·ä´·àç·çà·å†·à®·ãç)
      - name: "üìä Generate Static Dashboard"
        run: |
          cat << 'EOF' > generate_dashboard.py
          import sqlite3, os, datetime
          
          # ·ã≥·â≥·â§·ãô·äï ·çà·àç·åé ·àõ·åç·äò·âµ
          db_path = 'data/profit_master.db'
          if not os.path.exists(db_path):
              print("‚ö†Ô∏è Database not found, creating dummy dashboard")
              stats = {'articles': 0, 'revenue': 0.0}
          else:
              try:
                  conn = sqlite3.connect(db_path)
                  cursor = conn.cursor()
                  # ·à∞·äï·å†·à®·ã¶·âπ ·àò·äñ·à´·â∏·ãç·äï ·àõ·à®·åã·åà·å• (Error ·ä•·äï·ã≥·ã≠·çà·å†·à≠)
                  try:
                      cursor.execute("SELECT COUNT(*) FROM articles_pro")
                      articles = cursor.fetchone()[0]
                      cursor.execute("SELECT SUM(estimated_revenue) FROM articles_pro")
                      revenue = cursor.fetchone()[0] or 0.0
                  except:
                      articles = 0
                      revenue = 0.0
                  conn.close()
                  stats = {'articles': articles, 'revenue': revenue}
              except Exception as e:
                  print(f"Error reading DB: {e}")
                  stats = {'articles': 0, 'revenue': 0.0}

          html = f"""
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Profit Master Dashboard</title>
              <style>
                  body {{ font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }}
                  .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }}
                  .header {{ text-align: center; color: #1a73e8; }}
                  .metric-grid {{ display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }}
                  .card {{ background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #e1e4e8; }}
                  .value {{ font-size: 2.5em; font-weight: bold; color: #333; }}
                  .label {{ color: #666; text-transform: uppercase; font-size: 0.9em; }}
                  .footer {{ margin-top: 40px; text-align: center; font-size: 0.8em; color: #999; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üöÄ Profit Master Supreme v11.0</h1>
                      <p>Automated Execution Report</p>
                  </div>
                  <div class="metric-grid">
                      <div class="card">
                          <div class="value">{stats['articles']}</div>
                          <div class="label">Articles Generated</div>
                      </div>
                      <div class="card">
                          <div class="value">${stats['revenue']:.2f}</div>
                          <div class="label">Estimated Revenue</div>
                      </div>
                  </div>
                  <div class="footer">
                      Last Updated: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
                  </div>
              </div>
          </body>
          </html>
          """
          
          os.makedirs('public', exist_ok=True)
          with open('public/index.html', 'w') as f:
              f.write(html)
          print("‚úÖ Static dashboard generated")
          EOF
          
          python3 generate_dashboard.py

      # 7. ·ãç·å§·â±·äï ·ãà·ã∞ GitHub Pages ·àò·àç·âÄ·âÖ
      - name: "üåê Deploy to GitHub Pages"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      # 8. ·äñ·â≤·çä·ä¨·àΩ·äï ·àò·àã·ä≠ (Robust Method)
      - name: "üì≤ Send Notifications"
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          DISCORD: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          STATUS: ${{ job.status }}
        run: |
          cat << 'EOF' > notify.py
          import requests, os, json, sys

          status = os.getenv('STATUS')
          tg_token = os.getenv('TG_TOKEN')
          tg_chat = os.getenv('TG_CHAT')
          discord = os.getenv('DISCORD')
          
          repo = os.getenv('REPO').split('/')
          dashboard = f"https://{repo[0]}.github.io/{repo[1]}/"
          
          # Telegram Logic
          if tg_token and tg_chat:
              icon = "‚úÖ" if status == "success" else "‚ùå"
              msg = f"{icon} *Profit Master Report*\n\nStatus: {status.upper()}\nüîó [Dashboard]({dashboard})\nüÜî Run: {os.getenv('RUN_ID')}"
              try:
                  requests.post(
                      f"https://api.telegram.org/bot{tg_token}/sendMessage",
                      json={"chat_id": tg_chat, "text": msg, "parse_mode": "Markdown"}
                  )
                  print("Telegram sent.")
              except Exception as e:
                  print(f"Telegram failed: {e}")

          # Discord Logic
          if discord:
              color = 3066993 if status == "success" else 15158332
              payload = {
                  "embeds": [{
                      "title": "Profit Master Execution",
                      "description": f"Status: **{status.upper()}**",
                      "color": color,
                      "url": dashboard,
                      "fields": [{"name": "Dashboard", "value": dashboard}]
                  }]
              }
              try:
                  requests.post(discord, json=payload)
                  print("Discord sent.")
              except Exception as e:
                  print(f"Discord failed: {e}")
          EOF
          
          python3 notify.py

      # 9. Artifacts ·àõ·àµ·âÄ·àò·å• (·àà·ã≤·â†·åç)
      - name: "üíæ Upload Logs & Data"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-data
          path: |
            data/
            reports/
            public/
            *.log
          retention-days: 14
