name: Profit Master Executor - Enhanced Control

on:
  schedule:
    - cron: '0 */6 * * *'   # Every 6 hours
    - cron: '30 12 * * *'   # Daily at 12:30
    - cron: '0 0 */3 * *'   # Every 3 days at midnight
    - cron: '0 8 * * 1'     # Every Monday at 8:00 AM
  
  workflow_dispatch:        # Manual trigger
    inputs:
      debug-mode:
        description: 'Run in debug mode for detailed logging'
        required: false
        default: 'false'
        type: boolean
      report-only:
        description: 'Generate reports without executing trading operations'
        required: false
        default: 'false'
        type: boolean
      operation-type:
        description: 'Type of operation to perform'
        required: false
        default: 'full-cycle'
        type: choice
        options:
        - full-cycle
        - content-only
        - social-only
        - monetization-only
        - analytics-only
        - emergency-recovery

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

jobs:
  security-validation:
    runs-on: ubuntu-latest
    name: "üîí Validate Security Requirements"
    outputs:
      validation_passed: ${{ steps.validate.outputs.result }}
      missing_secrets: ${{ steps.validate.outputs.missing_secrets }}
    
    steps:
      - name: "üö® Validate Required Secrets"
        id: validate
        env:
          REQUIRED_SECRETS: GROQ_API_KEY,TWITTER_API_KEY,TWITTER_API_SECRET,TWITTER_ACCESS_TOKEN,TWITTER_ACCESS_SECRET,FACEBOOK_ACCESS_TOKEN,TELEGRAM_BOT_TOKEN,TELEGRAM_CHAT_ID
        run: |
          result="true"
          missing_secrets=""
          
          IFS=',' read -ra secrets_list <<< "$REQUIRED_SECRETS"
          for secret in "${secrets_list[@]}"; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå Missing required secret: $secret"
              missing_secrets+="$secret,"
              result="false"
            fi
          done
          
          if [ "$result" = "false" ]; then
            echo "‚ö†Ô∏è WARNING: The following required secrets are missing: ${missing_secrets%,}"
            echo "Some features may be limited or disabled."
          else
            echo "‚úÖ All required secrets are present"
          fi
          
          echo "result=$result" >> $GITHUB_OUTPUT
          echo "missing_secrets=${missing_secrets%,}" >> $GITHUB_OUTPUT

  system-initialization:
    needs: security-validation
    runs-on: ubuntu-latest
    name: "‚öôÔ∏è System Initialization"
    outputs:
      session_id: ${{ steps.generate_session.outputs.session_id }}
      environment: ${{ steps.setup_env.outputs.environment }}
    
    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "üÜî Generate Session ID"
        id: generate_session
        run: |
          SESSION_ID="PM_$(date +%Y%m%d%H%M%S)_${GITHUB_RUN_NUMBER}_$(openssl rand -hex 4)"
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "üîë Session ID: $SESSION_ID"
          
          # Create session info file
          cat > session_info.json << EOF
          {
            "session_id": "$SESSION_ID",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "triggered_by": "${{ github.event_name }}",
            "triggered_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "operation_type": "${{ github.event.inputs.operation-type || 'full-cycle' }}",
            "debug_mode": "${{ github.event.inputs.debug-mode || 'false' }}",
            "report_only": "${{ github.event.inputs.report-only || 'false' }}"
          }
          EOF

      - name: "‚öôÔ∏è Setup Environment Variables"
        id: setup_env
        run: |
          # Determine environment based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="staging"
          else
            ENV="development"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "üåç Environment: $ENV"
          
          # Create .env file with all secrets
          cat > .env << EOF
# Profit Master Supreme v12.0 Environment Configuration
# Generated: $(date)
# Session: ${{ steps.generate_session.outputs.session_id }}
# Environment: $ENV

# Core AI APIs
GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || '' }}
ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY || '' }}
GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY || '' }}

# Social Media APIs
TWITTER_API_KEY=${{ secrets.TWITTER_API_KEY }}
TWITTER_API_SECRET=${{ secrets.TWITTER_API_SECRET }}
TWITTER_ACCESS_TOKEN=${{ secrets.TWITTER_ACCESS_TOKEN }}
TWITTER_ACCESS_SECRET=${{ secrets.TWITTER_ACCESS_SECRET }}

FACEBOOK_ACCESS_TOKEN=${{ secrets.FACEBOOK_ACCESS_TOKEN }}
FACEBOOK_PAGE_ID=${{ secrets.FACEBOOK_PAGE_ID || '' }}

# Messaging
TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK || '' }}

# WordPress
WP_URL=${{ secrets.WP_URL || '' }}
WP_USERNAME=${{ secrets.WP_USERNAME || '' }}
WP_PASSWORD=${{ secrets.WP_PASSWORD || '' }}

# Affiliate Networks
AMAZON_ASSOCIATES_TAG=${{ secrets.AMAZON_ASSOCIATES_TAG || '' }}
SHAREASALE_ID=${{ secrets.SHAREASALE_ID || '' }}
CJ_PID=${{ secrets.CJ_PID || '' }}

# Image Generation
STABILITY_API_KEY=${{ secrets.STABILITY_API_KEY || '' }}
UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY || '' }}

# Database
DATABASE_URL=${{ secrets.DATABASE_URL || 'sqlite:///data/profit_master.db' }}
REDIS_URL=${{ secrets.REDIS_URL || '' }}

# System Configuration
ENVIRONMENT=$ENV
SESSION_ID=${{ steps.generate_session.outputs.session_id }}
DEBUG_MODE=${{ github.event.inputs.debug-mode || 'false' }}
REPORT_ONLY=${{ github.event.inputs.report-only || 'false' }}
OPERATION_TYPE=${{ github.event.inputs.operation-type || 'full-cycle' }}
GITHUB_RUN_ID=${{ github.run_id }}
GITHUB_REPO=${{ github.repository }}

# Feature Flags
ENABLE_GROQ_AI=true
ENABLE_WORDPRESS=${{ secrets.WP_URL != '' && 'true' || 'false' }}
ENABLE_SOCIAL_MEDIA=true
ENABLE_TELEGRAM=${{ secrets.TELEGRAM_BOT_TOKEN != '' && 'true' || 'false' }}
ENABLE_AI_IMAGES=${{ secrets.STABILITY_API_KEY != '' || secrets.UNSPLASH_ACCESS_KEY != '' && 'true' || 'false' }}
ENABLE_AFFILIATE_MONETIZATION=true
ENABLE_AUTO_SCHEDULING=true
ENABLE_TRENDING_TOPICS=true
ENABLE_MULTI_AGENT=true
ENABLE_STREAMLIT_GUI=true

# Content Settings
MIN_WORD_COUNT=2500
MAX_WORD_COUNT=3500
QUALITY_THRESHOLD=80
ORIGINALITY_THRESHOLD=75
ARTICLES_PER_DAY=3
SOCIAL_POSTS_PER_ARTICLE=3
AFFILIATE_LINKS_PER_ARTICLE=5

# Performance
MAX_WORKERS=3
REQUEST_TIMEOUT=45
MAX_RETRIES=5
DATABASE_PATH=data/profit_master.db
EOF

          echo "‚úÖ Environment variables configured for $ENV"

  execute_profit_master:
    needs: [security-validation, system-initialization]
    runs-on: ubuntu-latest
    name: "üöÄ Execute Profit Master Engine"
    timeout-minutes: 45
    
    steps:
      # 1. Repository checkout with submodules
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      # 2. Python 3.10 setup with caching
      - name: "üêç Setup Python 3.10"
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            **/requirements.txt
            **/requirements-dev.txt
            **/pyproject.toml
            **/setup.py

      # 3. Create necessary directories
      - name: "üìÅ Create Required Directories"
        run: |
          mkdir -p data images audio_output exports backups reports social_media quality_reports affiliate_data
          echo "‚úÖ Directories created successfully"

      # 4. Install dependencies with comprehensive package list
      - name: "üì¶ Install Comprehensive Dependencies"
        run: |
          echo "üîß Upgrading pip and installing dependencies..."
          python -m pip install --upgrade pip setuptools wheel
          
          # Core dependencies
          pip install pandas numpy requests schedule matplotlib seaborn plotly
          pip install python-dotenv beautifulsoup4 lxml Pillow
          pip install streamlit streamlit-option-menu fastapi uvicorn
          
          # AI and ML dependencies
          pip install groq openai anthropic google-generativeai
          pip install langchain chromadb sentence-transformers
          
          # Social media dependencies
          pip install tweepy facebook-sdk python-telegram-bot discord-webhook
          
          # Database dependencies
          pip install sqlalchemy psycopg2-binary redis
          
          # Additional utilities
          pip install apscheduler schedule textblob nltk
          pip install pyyaml jinja2 markdown
          
          # Testing and development
          pip install pytest coverage pylint black
          
          # Verify critical packages
          python -c "
          import pandas, numpy, requests, groq, tweepy, streamlit, sqlalchemy
          print('‚úÖ All critical packages verified successfully')
          "
          
          echo "‚úÖ All dependencies installed successfully!"

      # 5. Prepare output directory with cleanup
      - name: "üßπ Prepare Output Directory"
        run: |
          # Clean previous outputs but keep essential files
          mkdir -p public
          find public -type f ! -name 'index.html' -not -path '*/.gitkeep' -delete 2>/dev/null || true
          
          # Create initial dashboard structure
          cat > public/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Profit Master Supreme Dashboard</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                      margin: 0; 
                      padding: 20px; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container { 
                      max-width: 1200px; 
                      margin: 0 auto; 
                      background: rgba(255, 255, 255, 0.1); 
                      padding: 30px; 
                      border-radius: 15px; 
                      backdrop-filter: blur(10px);
                  }
                  .header { 
                      text-align: center; 
                      margin-bottom: 30px; 
                  }
                  .status { 
                      padding: 15px; 
                      border-radius: 10px; 
                      margin: 10px 0; 
                  }
                  .loading { 
                      background: #f0ad4e; 
                  }
                  .success { 
                      background: #5cb85c; 
                  }
                  .error { 
                      background: #d9534f; 
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üí∞ Profit Master Supreme Dashboard</h1>
                      <p>AI-Powered Content Monetization System</p>
                  </div>
                  <div class="status loading">
                      <h2>üîÑ System Initializing...</h2>
                      <p>Session ID: ${{ needs.system-initialization.outputs.session_id }}</p>
                      <p>Run ID: ${{ github.run_id }}</p>
                      <p>Started at: $(date)</p>
                  </div>
                  <div id="progress"></div>
              </div>
              <script>
                  // Auto-refresh every 10 seconds to show progress
                  setTimeout(() => location.reload(), 10000);
              </script>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Output directory prepared and cleaned"

      # 6. Execute Profit Master with comprehensive error handling
      - name: "ü§ñ Run Profit Master Engine"
        id: run_script
        env:
          SESSION_ID: ${{ needs.system-initialization.outputs.session_id }}
          ENVIRONMENT: ${{ needs.system-initialization.outputs.environment }}
          OPERATION_TYPE: ${{ github.event.inputs.operation-type || 'full-cycle' }}
          DEBUG_MODE: ${{ github.event.inputs.debug-mode || 'false' }}
          REPORT_ONLY: ${{ github.event.inputs.report-only || 'false' }}
          OUTPUT_DIR: 'public'
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          echo "üöÄ Starting Profit Master Supreme v12.0..."
          echo "üìä Session ID: $SESSION_ID"
          echo "üåç Environment: $ENVIRONMENT"
          echo "‚öôÔ∏è Operation Type: $OPERATION_TYPE"
          echo "üîç Debug mode: $DEBUG_MODE"
          echo "üìà Report only mode: $REPORT_ONLY"
          
          # Copy environment file
          cp .env .env.production
          
          # Create log file with timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          LOG_FILE="public/execution_log_${TIMESTAMP}.txt"
          
          # Determine which script to run
          if [ -f "profit_master_supreme.py" ]; then
              MAIN_SCRIPT="profit_master_supreme.py"
          elif [ -f "profit_machine_enterprise.py" ]; then
              MAIN_SCRIPT="profit_machine_enterprise.py"
          elif [ -f "main.py" ]; then
              MAIN_SCRIPT="main.py"
          else
              echo "‚ùå ERROR: No main script found!"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
          fi
          
          echo "üìù Using script: $MAIN_SCRIPT"
          
          # Create execution command based on operation type
          case $OPERATION_TYPE in
              "full-cycle")
                  CMD="python3 -u $MAIN_SCRIPT --auto --report --publish"
                  ;;
              "content-only")
                  CMD="python3 -u $MAIN_SCRIPT --auto --content-only"
                  ;;
              "social-only")
                  CMD="python3 -u $MAIN_SCRIPT --auto --social-only"
                  ;;
              "monetization-only")
                  CMD="python3 -u $MAIN_SCRIPT --auto --monetization-only"
                  ;;
              "analytics-only")
                  CMD="python3 -u $MAIN_SCRIPT --report --detailed"
                  ;;
              "emergency-recovery")
                  CMD="python3 -u $MAIN_SCRIPT --recover --backup latest"
                  ;;
              *)
                  CMD="python3 -u $MAIN_SCRIPT --auto --report"
                  ;;
          esac
          
          # Add debug flag if needed
          if [ "$DEBUG_MODE" = "true" ]; then
              CMD="$CMD --debug"
          fi
          
          echo "üíª Executing command: $CMD"
          echo "üìÑ Logging to: $LOG_FILE"
          
          # Execute with timeout and logging
          timeout 2400 $CMD 2>&1 | tee "$LOG_FILE"
          EXIT_CODE=${PIPESTATUS[0]}
          
          # Handle different exit codes
          if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Profit Master executed successfully"
              echo "status=success" >> $GITHUB_OUTPUT
              
              # Check for generated output
              GENERATED_FILES=$(find public -name "*.html" -o -name "*.json" -o -name "*.csv" | wc -l)
              echo "üìä Generated $GENERATED_FILES output files"
              
          elif [ $EXIT_CODE -eq 124 ]; then
              echo "‚è∞ WARNING: Execution timed out after 40 minutes"
              echo "status=timeout" >> $GITHUB_OUTPUT
          else
              echo "‚ùå ERROR: Profit Master execution failed with code $EXIT_CODE"
              echo "status=failed" >> $GITHUB_OUTPUT
              
              # Create error report
              cat > public/error_report.html << EOF
              <!DOCTYPE html>
              <html>
              <head><title>Profit Master - Error Report</title></head>
              <body style="font-family: Arial; margin: 40px;">
                  <h1>‚ùå Profit Master Execution Error</h1>
                  <p>An error occurred during execution. Please check the logs.</p>
                  <h2>Details:</h2>
                  <ul>
                      <li>Session: $SESSION_ID</li>
                      <li>Run ID: $GITHUB_RUN_ID</li>
                      <li>Time: $(date)</li>
                      <li>Exit Code: $EXIT_CODE</li>
                  </ul>
                  <h3>Last 50 lines of log:</h3>
                  <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
                  $(tail -50 "$LOG_FILE" 2>/dev/null || echo "No log available")
                  </pre>
              </body>
              </html>
              EOF
          fi
          
          # Create execution summary
          cat > public/execution_summary.json << EOF
          {
              "session_id": "$SESSION_ID",
              "run_id": "$GITHUB_RUN_ID",
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "environment": "$ENVIRONMENT",
              "operation_type": "$OPERATION_TYPE",
              "debug_mode": "$DEBUG_MODE",
              "report_only": "$REPORT_ONLY",
              "exit_code": $EXIT_CODE,
              "status": "${{ steps.run_script.outputs.status }}",
              "log_file": "$LOG_FILE",
              "generated_files": $GENERATED_FILES
          }
          EOF

      # 7. Upload artifacts for debugging
      - name: "üíæ Upload Execution Artifacts"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: profit-master-execution-${{ github.run_id }}
          path: |
            public/
            data/*.db
            logs/
            reports/
            execution_summary.json
            .env.production
          retention-days: 30
          compression-level: 9

      # 8. Deploy to GitHub Pages with verification
      - name: "üåê Deploy Dashboard to GitHub Pages"
        if: steps.run_script.outputs.status == 'success' || steps.run_script.outputs.status == 'timeout'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          force_orphan: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: |
            ‚úÖ Automated dashboard update - Session: ${{ needs.system-initialization.outputs.session_id }}
            
            ‚Ä¢ Run ID: ${{ github.run_id }}
            ‚Ä¢ Environment: ${{ needs.system-initialization.outputs.environment }}
            ‚Ä¢ Operation: ${{ github.event.inputs.operation-type || 'full-cycle' }}
            ‚Ä¢ Time: $(date +%Y-%m-%d_%H:%M:%S)
            
            Generated by Profit Master Supreme v12.0

      # 9. Notifications - Success
      - name: "‚úÖ Success Notification"
        if: success() && steps.run_script.outputs.status == 'success'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK || '' }}
        run: |
          REPO_NAME=$(basename "${GITHUB_REPOSITORY}")
          DASHBOARD_URL="https://${GITHUB_ACTOR}.github.io/${REPO_NAME}/"
          LOGS_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          SESSION_ID="${{ needs.system-initialization.outputs.session_id }}"
          
          # Create success message
          MESSAGE="‚úÖ *Profit Master Supreme v12.0* executed successfully!
          
üìä *Execution Details:*
‚Ä¢ Session: \`${SESSION_ID}\`
‚Ä¢ Dashboard: [View Live](${DASHBOARD_URL})
‚Ä¢ Run ID: #${GITHUB_RUN_ID}
‚Ä¢ Environment: ${{ needs.system-initialization.outputs.environment }}
‚Ä¢ Operation: ${{ github.event.inputs.operation-type || 'full-cycle' }}
‚Ä¢ Time: $(date)

üìà *Next scheduled run:* In 6 hours
üîç [View Logs](${LOGS_URL})"
          
          # Telegram notification
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            echo "üì± Sending Telegram notification..."
            
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": false}"
            
            echo "‚úÖ Telegram notification sent"
          fi
          
          # Discord notification (optional)
          if [ -n "$DISCORD_WEBHOOK" ]; then
            echo "üí¨ Sending Discord notification..."
            
            PAYLOAD=$(cat <<EOF
            {
              "username": "Profit Master Bot",
              "avatar_url": "https://cdn-icons-png.flaticon.com/512/3144/3144456.png",
              "embeds": [
                {
                  "title": "‚úÖ Profit Master Execution Successful",
                  "description": "Dashboard updated successfully",
                  "color": 3066993,
                  "fields": [
                    {
                      "name": "Dashboard",
                      "value": "[View Live Dashboard](${DASHBOARD_URL})"
                    },
                    {
                      "name": "Session ID",
                      "value": "\`${SESSION_ID}\`",
                      "inline": true
                    },
                    {
                      "name": "Run ID",
                      "value": "${GITHUB_RUN_ID}",
                      "inline": true
                    },
                    {
                      "name": "Environment",
                      "value": "${{ needs.system-initialization.outputs.environment }}",
                      "inline": true
                    }
                  ],
                  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                  "footer": {
                    "text": "GitHub Actions | Profit Master Supreme v12.0"
                  }
                }
              ]
            }
            EOF
            )
            
            curl -s -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
            echo "‚úÖ Discord notification sent"
          fi

      # 10. Notifications - Warning (Timeout)
      - name: "‚ö†Ô∏è Warning Notification (Timeout)"
        if: steps.run_script.outputs.status == 'timeout'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REPO_NAME=$(basename "${GITHUB_REPOSITORY}")
          LOGS_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          MESSAGE="‚ö†Ô∏è *Profit Master System* execution TIMEOUT!
          
‚è∞ Execution timed out after 40 minutes
üÜî Run ID: #${GITHUB_RUN_ID}
üîç Debug URL: ${LOGS_URL}
üìä Dashboard may be partially updated

*System will retry on next scheduled run*"
          
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"Markdown\"}"
          fi

      # 11. Notifications - Failure
      - name: "‚ùå Failure Notification"
        if: failure() || steps.run_script.outputs.status == 'failed'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REPO_NAME=$(basename "${GITHUB_REPOSITORY}")
          LOGS_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          MESSAGE="‚ùå *Profit Master System* execution FAILED!
          
‚ö†Ô∏è Execution failed at: $(date)
üÜî Run ID: #${GITHUB_RUN_ID}
üîç Debug URL: ${LOGS_URL}
            
*Please check logs and fix issues before next scheduled run*"
          
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"Markdown\"}"
          fi

      # 12. Cleanup and finalization
      - name: "üßπ Final Cleanup and Report"
        if: always()
        run: |
          echo "üßπ Cleaning up temporary files..."
          rm -rf ~/.cache/pip
          rm -rf __pycache__
          rm -f .env.production
          
          # Create final summary
          cat > public/final_summary.md << EOF
          # Profit Master Supreme - Execution Summary
          
          ## Run Information
          - **Session ID**: ${{ needs.system-initialization.outputs.session_id }}
          - **Run ID**: ${{ github.run_id }}
          - **Execution Time**: $(date)
          - **Environment**: ${{ needs.system-initialization.outputs.environment }}
          - **Operation Type**: ${{ github.event.inputs.operation-type || 'full-cycle' }}
          - **Status**: ${{ steps.run_script.outputs.status || 'unknown' }}
          
          ## System Status
          - **Security Validation**: ${{ needs.security-validation.outputs.validation_passed }}
          - **Missing Secrets**: ${{ needs.security-validation.outputs.missing_secrets || 'None' }}
          - **Generated Files**: $(find public -type f | wc -l)
          - **Database Size**: $(du -sh data/profit_master.db 2>/dev/null | cut -f1 || echo "N/A")
          
          ## Next Steps
          1. Review the dashboard at: https://${GITHUB_ACTOR}.github.io/$(basename "${GITHUB_REPOSITORY}")/
          2. Check execution logs for details
          3. Monitor revenue and performance metrics
          4. Schedule next execution if needed
          
          ## Support
          For issues or questions, please check the documentation or create an issue in the repository.
          
          *Automatically generated by Profit Master Supreme v12.0*
          EOF
          
          echo "‚úÖ Cleanup completed and final summary generated"

  system-monitoring:
    needs: execute_profit_master
    runs-on: ubuntu-latest
    name: "üìä System Monitoring"
    if: always()
    
    steps:
      - name: "üìà Generate Monitoring Report"
        run: |
          echo "üìä Profit Master System Monitoring Report"
          echo "=========================================="
          echo ""
          echo "Execution Status: ${{ needs.execute_profit_master.result }}"
          echo "Completion Time: $(date)"
          echo "Run Duration: ${{ github.event.workflow_run.run_duration }} seconds"
          echo ""
          echo "üìÅ Generated Artifacts:"
          echo "  ‚Ä¢ Dashboard: https://${GITHUB_ACTOR}.github.io/$(basename "${GITHUB_REPOSITORY}")/"
          echo "  ‚Ä¢ Logs: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo ""
          echo "üîÑ Next Scheduled Runs:"
          echo "  ‚Ä¢ Every 6 hours"
          echo "  ‚Ä¢ Daily at 12:30 UTC"
          echo "  ‚Ä¢ Every 3 days at midnight"
          echo "  ‚Ä¢ Every Monday at 8:00 AM"
          echo ""
          echo "üîß System Health:"
          echo "  ‚Ä¢ Dependencies: Installed"
          echo "  ‚Ä¢ Environment: Configured"
          echo "  ‚Ä¢ Secrets: ${{ needs.security-validation.outputs.validation_passed == 'true' && 'Valid' || 'Missing some' }}"
          echo ""
          echo "‚úÖ Monitoring complete. System is operational."
