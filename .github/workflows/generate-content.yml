name: Generate Content

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Article topic'
        required: true
        default: 'AI in Healthcare'
      country:
        description: 'Target country'
        required: true
        default: 'US'
      niche:
        description: 'Business niche'
        required: true
        default: 'Technology'
      batch_size:
        description: 'Number of articles (0 for single)'
        required: false
        default: '0'
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/generate-content.yml'
      - 'profit_machine_v11.py'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp matplotlib beautifulsoup4 requests cryptography
        pip install numpy pandas sqlalchemy pytest
        pip install openai==1.12.0
        echo "âœ… Dependencies installed"
    
    - name: Create necessary directories
      run: |
        mkdir -p data exports logs exports/reports exports/images exports/social backups
        echo "ðŸ“ Directories created"
    
    - name: Create configuration file
      run: |
        cat > config_complete.json << 'EOF'
        {
          "GROQ_API_KEY": "${{ secrets.GROQ_API_KEY }}",
          "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
          "PERPLEXITY_API_KEY": "${{ secrets.PERPLEXITY_API_KEY }}",
          "NEWS_API_KEY": "${{ secrets.NEWS_API_KEY }}",
          "DALLE_API_KEY": "${{ secrets.DALLE_API_KEY }}",
          "STABILITY_API_KEY": "${{ secrets.STABILITY_API_KEY }}",
          "DATABASE_PATH": "data/profit_machine_v11_complete.db",
          "EXPORT_DIR": "exports",
          "LOG_DIR": "logs",
          "TARGET_COUNTRIES": ["US", "UK", "DE", "CA", "AU", "FR", "JP", "SG", "CH", "NL"],
          "PRIORITY_NICHES": ["Technology", "Finance", "Business", "Health", "Real Estate", "Education"],
          "MIN_WORD_COUNT": 2000,
          "MAX_WORD_COUNT": 4000,
          "IMAGE_PER_ARTICLE": 3
        }
        EOF
        echo "âš™ï¸ Configuration file created"
    
    - name: Run Profit Machine v11.0
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        DALLE_API_KEY: ${{ secrets.DALLE_API_KEY }}
        STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
      run: |
        python profit_machine_v11.py \
          --topic "${{ github.event.inputs.topic || 'AI in Healthcare' }}" \
          --country "${{ github.event.inputs.country || 'US' }}" \
          --niche "${{ github.event.inputs.niche || 'Technology' }}" \
          --batch "${{ github.event.inputs.batch_size || '0' }}"
    
    - name: Upload generated content
      uses: actions/upload-artifact@v4  # CHANGED FROM v3 TO v4
      with:
        name: generated-content
        path: |
          exports/
          logs/
          data/
        retention-days: 7
    
    - name: Create summary report
      if: always()
      run: |
        echo "# ðŸ† Content Generation Report" > summary.md
        echo "## Generated on: $(date)" >> summary.md
        echo "## Topic: ${{ github.event.inputs.topic || 'AI in Healthcare' }}" >> summary.md
        echo "## Country: ${{ github.event.inputs.country || 'US' }}" >> summary.md
        echo "## Files Generated:" >> summary.md
        find exports/ -type f -name "*.html" -o -name "*.json" -o -name "*.md" | while read file; do
          echo "- $(basename "$file")" >> summary.md
        done
        echo "## ðŸ“Š Storage Usage:" >> summary.md
        du -sh exports/ data/ logs/ | awk '{print "- " $2 ": " $1}' >> summary.md
    
    - name: Upload summary report
      uses: actions/upload-artifact@v4  # CHANGED FROM v3 TO v4
      with:
        name: generation-summary
        path: summary.md
    
    - name: Send notification (Optional)
      if: always()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_TITLE: "Content Generation ${{ job.status }}"
        SLACK_MESSAGE: "Generated content for ${{ github.event.inputs.topic || 'AI in Healthcare' }} in ${{ github.event.inputs.country || 'US' }}"
