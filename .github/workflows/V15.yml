name: Profit Master Supreme v15.1 - Fix Checkout

on:
  schedule:
    - cron: '*/30 * * * *'
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      operation_type:
        description: 'Mode'
        default: 'full-cycle'

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PYTHON_VERSION: '3.10'
  DATABASE_FILE: 'profit_master.db'
  OUTPUT_DIR: 'public'

jobs:
  # ==================== JOB 1: BOOT ====================
  system_boot:
    runs-on: ubuntu-latest
    name: "ğŸš€ System Boot"
    outputs:
      session_id: ${{ steps.gen_id.outputs.session_id }}
    
    steps:
      - name: "ğŸ“¥ Checkout Code"  # 1. áŠ®á‹±áŠ• áŠ¥áŠ“á‹ˆáˆ­á‹³áˆˆáŠ•
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ†” Generate Session ID"
        id: gen_id
        run: echo "session_id=PM_$(date +%Y%m%d)_${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: "ğŸ“‚ Init DB"
        run: |
          mkdir -p data public
          cat << 'EOF' > init_db.py
          import sqlite3, os
          os.makedirs('data', exist_ok=True)
          conn = sqlite3.connect('data/profit_master.db')
          conn.close()
          print("âœ… DB Init")
          EOF
          python3 init_db.py

      - name: "ğŸ“¤ Upload State"
        uses: actions/upload-artifact@v4
        with:
          name: system-state
          path: data/

  # ==================== JOB 2: CORE (THE FIX) ====================
  core_operations:
    needs: system_boot
    runs-on: ubuntu-latest
    name: "ğŸ¤– Execute Engine"
    timeout-minutes: 120
    
    steps:
      - name: "ğŸ“¥ Checkout Code (AGAIN)"  # <--- á‹­áˆ„ áŠá‹ áˆ˜áá‰µáˆ„á‹!
        uses: actions/checkout@v4

      - name: "ğŸ“¥ Download State"
        uses: actions/download-artifact@v4
        with:
          name: system-state
          path: data/

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: "ğŸ“¦ Install Deps"
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          pip install pandas numpy requests schedule plotly streamlit groq google-generativeai \
          openai anthropic cohere tweepy facebook-sdk python-telegram-bot discord-webhook \
          beautifulsoup4 lxml Pillow gTTS moviepy yt-dlp sqlalchemy streamlit-option-menu \
          pydantic fastapi uvicorn nltk spacy textblob prometheus-client boto3
          python -m nltk.downloader punkt stopwords averaged_perceptron_tagger

      - name: "ğŸ¤– Run Script"
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DATABASE_URL: "sqlite:///data/profit_master.db"
          OPERATION: ${{ github.event.inputs.operation_type || 'full-cycle' }}
        run: |
          echo "ğŸš€ Searching for script..."
          # áŠ áˆáŠ• checkout áˆµáˆ‹á‹°áˆ¨áŒáŠ• á‹á‹­áˆ‰ áˆ˜áŒˆáŠ˜á‰µ áŠ áˆˆá‰ á‰µ
          ls -la
          
          SCRIPT_PATH=$(find . -maxdepth 2 -name "main.py" -o -name "profit_master_supreme.py" | head -n 1)
          
          if [ -z "$SCRIPT_PATH" ]; then
            echo "âŒ STILL MISSING! Please make sure 'main.py' is in the repo root."
            exit 1
          fi
          
          echo "âœ… Found: $SCRIPT_PATH"
          python3 -u "$SCRIPT_PATH" --auto

      - name: "ğŸ“¤ Upload Results"
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: |
            data/
            public/
            *.json

  # ==================== JOB 3: REPORT ====================
  reporting:
    needs: core_operations
    runs-on: ubuntu-latest
    name: "ğŸ“Š Report"
    
    steps:
      - name: "ğŸ“¥ Download Results"
        uses: actions/download-artifact@v4
        with:
          name: results

      - name: "ğŸ“Š Generate Dashboard"
        run: |
          mkdir -p public
          echo "<html><body><h1>Profit Master Active</h1></body></html>" > public/index.html

      - name: "ğŸŒ Deploy"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true
